"use strict";var Utils={Log:e=>{},assert:e=>{console.warn(`[Pulse] - ${e}`)},warn:e=>{console.error(`[Pulse] - ${e}`)}},Utils_1=Utils.Log,Utils_2=Utils.assert,Utils_3=Utils.warn;class Collection{constructor({name:e,global:t},{data:s={},model:i={},actions:n={},filters:o={},indexes:r=[],groups:a=[],routes:l={},watch:h={},persist:c=[],local:d={},onReady:p}){this._name=e,this._actionRefrence={collect:this.collect.bind(this),undo:this.undo.bind(this),move:this.move.bind(this),update:this.update.bind(this),put:this.put.bind(this),delete:this.delete.bind(this),deleteGroup:this.deleteGroup.bind(this),findById:this.findById.bind(this),getGroup:this.getGroup.bind(this),newGroup:this.newGroup.bind(this),forceUpdate:this.forceUpdate.bind(this),throttle:this.throttle.bind(this),remove:this.remove.bind(this),set:this.set.bind(this),increment:this.increment.bind(this),decrement:this.decrement.bind(this),purge:this.purge.bind(this),watch:this.watch.bind(this),replaceIndex:this.replaceIndex.bind(this)};this._public=this.initProxy({groups:{},data:{},actions:{},filters:{},routes:{},indexes:{}}),this._global=t,this._regenQueue=this._global.regenQueue,this._onReady=p,this._model=i,this._filters=o,this._local=d,this._data={},this._indexes={},this._watchers={},this._storage={},this._filtersRelatedToData={},this._filtersRelatedToGroup={},this._relations={},this._groupRelations={},this._foreignGroupRelations={},this._subscribedToData={},this._watchers={},this._internalWatchers={},this._persist=[],this._throttles=[],this._modelTypes=[],this._mutableData=[],this._indexesToRegen=[],this._filtersToForceRegen=[],this._actionProcessingStack=[],this._collectionSize=0,this._primaryKey=null,this._executing=!1,this._collecting=!1,this._performingAction=!1,this._allowInternalChange=!1,this._global.internalDataRef[this._name]=this._data,this.initStorage(),this.initModel(i),this.initData(s),this.initGroups(r.concat(a)),this.initRoutes(l),this.initFilters(o),this.initActions(n),this.initWatchers(h),this.prepareNamespace(),this.initPersist(c),this.initOnReady(p)}initStorage(){if(this._storageIsPromise=!!this._global.storage.async,"function"!=typeof this._global.storage.get)return this._global.storageInvalid=!0,Utils_2("Unable to access local storage, please assign a valid storage solution manually if you want data from Pulse to persist.");this._global.storage.get("_")instanceof Promise&&(this._storageIsPromise=!0);let e=e=>new Promise(async t=>{try{let s=await this._global.storage.get(e);return t("string"!=typeof s?s:JSON.parse(s))}catch{t(null)}}),t=e=>{let t=this._global.storage.get(e);try{return JSON.parse(t)}catch(e){return t}};this._storage.get=s=>this._storageIsPromise?e(s):t(s),this._storage.set=(e,t)=>{this._global.storage.set(e,JSON.stringify(t))},this._storage.remove=e=>this._global.storage.remove(e)}initPersist(e){this._global.storageInvalid||e.forEach(e=>{this._persist.push(e);let t=`_${this._name}_${e}`;if(!this._public.hasOwnProperty(e))return Utils_2(`Unable to persist property "${e}" in collection "${this._name}" as it does not exist.`);let s=this.searchNamespaceForProperty(e);if(!s)return Utils_2("Unable to persist. Property does not exist.");if(this._storageIsPromise)this._storage.get(t).then(t=>{null!=t&&(this._public[s][e]=t,this._public.hasOwnProperty(e)&&(this._public[e]=t))});else{let i=this._storage.get(t);if(null==i)return;i=this.initDeepReactivity(i,e),this._allowInternalChange=!0,this._public[s][e]=i,this._public.hasOwnProperty(e)&&(this._allowInternalChange=!0,this._public[e]=i)}})}initData(e){Object.keys(e).forEach(t=>{this._mutableData.push(t),e[t]=this.initDeepReactivity(e[t],t)}),this._public.data=this.initProxy(e)}initGroups(e){this._public.groups=this.initProxy({});for(let t=0;t<e.length;t++){const s=e[t];if(this._public.groups[s]||this._indexes[s])return Utils_2(`Duplicate declaration for index ${s}`);this._indexes[s]=new Array,this._public.groups[s]=new Array,this._public.indexes[s]=new Array}this._public.indexes=this.initProxy(this._public.indexes,"indexes")}initFilters(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const s=t[e];this._public.filters[s]=[],this._global.allFilters.push(s)}}initRoutes(e){const t=Object.keys(e);for(let s=0;s<t.length;s++){const i=t[s],n=this;this._public.routes[i]=function(){return Object.assign(n._global.request).context=n.getContextObject(),e[i].apply(null,[n._global.request].concat(Array.prototype.slice.call(arguments)))}}}getContextObject(){return Object.assign({data:this._public.data,filters:this._public.filters,groups:this._public.groups,actions:this._public.actions,routes:this._public.routes},this._global.dataRef,this._actionRefrence,{local:this._local})}initActions(e){const t=this,s=Object.keys(e);for(let i=0;i<s.length;i++){const n=s[i];this._public.actions[n]=function(){if(t._throttles.includes(n))return Promise.resolve();const s=arguments,i=Math.random();let o=null;t._actionProcessingStack.length>0&&(o=t._actionProcessingStack[t._actionProcessingStack.length-1].actionIdentifier);const r=t.getContextObject();r.undo=function(e){return t.undo(n,i,e)};const a={id:i,name:n,parentAction:o,runAction:function(){return e[n].apply(null,[r].concat(Array.prototype.slice.call(s)))}};return t.executeAction(a)}}}executeAction(e){this._performingAction=e.name,this._actionProcessingStack.push(e);const t=e.runAction();return this._performingAction=!1,this._actionProcessingStack.pop(),this._actionProcessingStack.length,t}initWatchers(e){const t=this;let s=Object.keys(e);for(let i=0;i<s.length;i++){const n=s[i];this._watchers[n]=function(){return e[n](t.getContextObject())}}}initOnReady(e){const t=this;this._onReady=function(){e&&e(t.getContextObject())}}initProxy(e={},t=!1,s=!1){let i;if(t)i=Object.create({rootProperty:t});else{let e=Object.assign({},this._actionRefrence,t);i=Object.create(e)}const n=Object.keys(e);for(let t=0;t<n.length;t++){const s=n[t];i[s]=e[s]}return s?new Proxy(i,{set:(e,t,s)=>{if(Object.getPrototypeOf(e).rootProperty){let i=Object.getPrototypeOf(e).rootProperty;return this._mutableData.includes(i)&&(e[t]=s,this.updateSubscribers(i,this._public[i]),this.findAndUpdateDependents(i)),!0}return e[t]=s,!0},get:(e,t,s)=>e[t]}):"indexes"===t?new Proxy(i,{set:(e,t,s)=>(e[t]=s,this._allowInternalChange||this.replaceIndex(t,s,!0),!0),get:(e,t,s)=>e[t]}):new Proxy(i,{set:(e,s,i)=>{if(!this._global.initComplete||this._allowInternalChange)return e[s]=i,this._allowInternalChange=!1,!0;if(this._mutableData.includes(s)){let n=e[s];e[s]=i,this.recordHistory("mutation",{key:s,rootProperty:t,previousValue:n,newValue:i});let o=this.initDeepReactivity(e[s],s);return e[s]=o,this._allowInternalChange=!0,this._public.data[s]=i,this._allowInternalChange=!1,this.updateSubscribers(s,i),this.findAndUpdateDependents(s),!0}return Object.keys(this._public).includes(s)?Utils_2(`Cannot set data property "${s}" in collection "${this._name}". Filters and groups are not mutable.`):Utils_2(`Cannot set data property "${s}" in collection "${this._name}" as "${s}" does not exist.`),!0},get:(e,t,s)=>Object.getPrototypeOf(e).rootProperty?e[t]:(this._global.record&&!["filters","groups","indexes","data","actions"].includes(t)&&0===this._global.dependenciesFound.filter(e=>e.property===t&&e.collection===this._name).length&&this._global.dependenciesFound.push({property:t,collection:this._name}),e[t])})}replaceIndex(e,t,s){let i=this._indexes[e];this._indexes[e]=t,this.buildGroupFromIndex(e,s),this.findAndUpdateDependents(e),this.recordHistory("indexMutation",{index:e,previousIndex:i,newIndex:t})}isWatchableObject(e){return null!=e&&"object"==typeof e&&!this.isHTMLElement(e)&&!Array.isArray(e)}isHTMLElement(e){try{return e instanceof HTMLElement}catch(t){return"object"==typeof e&&1===e.nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument}}initDeepReactivity(e,t){let s=[];if(!this.isWatchableObject(e))return e;const i=this.initProxy(e,t,!0),n=Object.keys(e);for(let t=0;t<n.length;t++){const i=n[t];this.isWatchableObject(e[i])&&s.push({target:e,key:i})}const o=()=>{const e=s;s=[];for(let i=0;i<e.length;i++){const{key:n,target:o}=e[i];this._allowInternalChange=!0,o[n]=this.initProxy(o[n],t,!0);const r=Object.keys(o[n]);for(let e=0;e<r.length;e++){const t=r[e];this.isWatchableObject(o[n][t])&&s.push({target:o[n],key:t})}}s.length>0?o():this._allowInternalChange=!1};return o(),i}initModel(e){Object.keys(e).forEach(t=>{Object.keys(e[t]).forEach(s=>{if("primaryKey"===s)this._primaryKey=t;else if("type"===s)["string","boolean","integer","number","array","object"].includes(e[t].type)?this._modelTypes.includes(t)||this._modelTypes.push(t):Utils_2(`Error in model in collection "${this._name}", type "${e[t].type}" is not valid.`);else if("parent"===s||"hasOne"===s){let s=e[t].parent||e[t].hasOne;this.createDataRelation(t,s,e[t].assignTo)}else if("has"===s||"hasMany"===s){let s=e[t].has||e[t].hasMany;this.createGroupRelation(t,s,e[t].assignTo)}})})}createDataRelation(e,t,s){if(!this._global.collectionNamespace.includes(t))return Utils_2(`"${collection}" is not a valid collection.`);this._relations[e]={},this._relations[e].fromCollectionName=t,s&&(this._relations[e].assignTo=s)}createGroupRelation(e,t,s){if(!this._global.collectionNamespace.includes(t))return Utils_2(`"${collection}" is not a valid collection.`);this._groupRelations[e]={},this._groupRelations[e].fromCollectionName=t,s&&(this._groupRelations[e].assignTo=s)}searchNamespaceForProperty(e){const t=["filters","data","groups"];for(let s=0;s<t.length;s++){const i=t[s];if(Object.keys(this._public[i]).includes(e))return i}return!1}validateNamespace(e,t){return Object.keys(e).forEach(s=>{if(e.hasOwnProperty(t))return Utils_3(`Duplicate property "${t}" on collection "${this._name}"`),!1}),!0}prepareNamespace(){Object.keys(this._public).forEach(e=>{["data","actions","groups","filters"].includes(e)&&Object.keys(this._public[e]).forEach(t=>{this.validateNamespace(this._public,t)&&(this._public[t]=this._public[e][t])})})}checkNamespace(e){return!!this._public.data.hasOwnProperty(e)||(Utils_2(`Namespace error "${e}" is already taken for collection "${this._name}".`),!1)}persistData(e,t){if(this._persist.includes(e)){let s=`_${this._name}_${e}`;this._storage.set(s,t)}}findPrimaryKey(e){const t=["id","_id"];for(let s=0;s<t.length;s++){const i=t[s];e.hasOwnProperty(i)&&(this._primaryKey=i)}this._primaryKey||this.dataRejectionHandler(e,"No primary key supplied.")}createRelationForIndex(e){const t=Object.keys(this._relations);for(let s=0;s<t.length;s++){const i=t[s];this._relations[i][e]=[]}}analyseFilters(){if(!this._filters)return;const e=Object.keys(this._filters);for(let t=0;t<e.length;t++){const s=e[t];this.executeAndAnalyseFilter(s)}}executeAndAnalyseFilter(e){this._global.record=!0,this.executeFilter(e);const t=this._global.dependenciesFound;this._global.dependenciesFound=[];for(let s=0;s<t.length;s++){const i=t[s];if(this.checkForMissingDependency(i,e))return}this.populateDependencies(t,e),this._global.generatedFilters.push(this._name+e),Utils_1(`Generated ${e} for collection ${this._name}`)}executeFilter(e){this._executing=e;const t=Object.assign({data:this._public.data,filters:this._public.filters,groups:this._public.groups,actions:this._public.actions},this._global.dataRef,this._actionRefrence,{local:this._local});let s=this._filters[e](t);this._executing=!1,this._global.record=!1,null==s&&(s=!1),this.deliverUpdate("filters",s,e)}emitToRoot(e,t={}){this._global.eventBus.message={type:e,data:t}}buildGroupFromIndex(e,t){const s=[];for(let t=0;t<this._indexes[e].length;t++){let i=this._indexes[e][t],n=this._data[i];if(!n)continue;let o=Object.keys(this._relations);if(o.length>0)for(let e=0;e<o.length;e++){const t=o[e],s=this._relations[t],i=!!s.hasOwnProperty("assignTo")&&s.assignTo;if(n.hasOwnProperty(t)){let e=this._global.internalDataRef[s.fromCollectionName][n[t]];e&&(i?n[i]=e:n[s.fromCollectionName]=e)}}let r=Object.keys(this._groupRelations);if(r.length>0)for(let t=0;t<r.length;t++){const s=r[t],i=this._groupRelations[s],o=!!i.hasOwnProperty("assignTo")&&i.assignTo;if(n.hasOwnProperty(s)){const t=this._global.dataRef[i.fromCollectionName][n[s]];t&&(o?n[o]=t:n[i.fromCollectionName]=t),this.emitToRoot("createForeignGroupRelation",{foreignCollection:i.fromCollectionName,foreignData:n[s],dependentCollection:this._name,dependentGroup:e})}}s.push(n)}return(this._public.hasOwnProperty(e)||this._public.groups.hasOwnProperty(e))&&this.deliverUpdate("groups",s,e),t||(this._allowInternalChange=!0,this._public.indexes[e]=this._indexes[e],this._allowInternalChange=!1),this.findFiltersToRegenFromRelatedGroup(e),s}internalDataModified(e){if(Array.isArray(e))for(let t=0;t<e.length;t++){const s=e[t];this.findGroupsToRegen(s),this.findFiltersToRegenFromRelatedData(s)}else this.findGroupsToRegen(e),this.findFiltersToRegenFromRelatedData(e);this.regenerateGroupsAndFilters()}deliverUpdate(e,t,s){this._allowInternalChange=!0,this._public[e][s]=t,this._allowInternalChange=!1,this._public.hasOwnProperty(s)&&(this._allowInternalChange=!0,this._public[s]=t,this._allowInternalChange=!1),this.updateSubscribers(s,t);const i=Object.keys(this._foreignGroupRelations);for(let e=0;e<i.length;e++){const t=i[e];s===t&&this.emitToRoot("rebuildGroupsWithRelations",this._foreignGroupRelations[t])}}updateSubscribers(e,t){this._watchers.hasOwnProperty(e)&&setTimeout(()=>this._watchers[e](this._global.dataRef)),this._internalWatchers.hasOwnProperty(e)&&setTimeout(()=>{for(let t=0;t<this._internalWatchers[e].length;t++){(0,this._internalWatchers[e][t])()}}),this.persistData(e,t);let s=this._global.config.framework;if(this._subscribedToData[e])for(let i=0;i<this._subscribedToData[e].length;i++){const n=this._subscribedToData[e][i];let o=this._global.componentStore[n.componentUUID];if(!o)return;if("vue"===s||o.hasOwnProperty("$vnode"))o.__pulseComponentReady&&o.$set(o,n.key,t);else if("react"===s||o.hasOwnProperty("_reactInternalInstance")){let e={};e[n.key]=t,o.state.hasOwnProperty("_mounted")?o.state._mounted&&o.setState(e):o.hasOwnProperty("__pulseComponentReady")?o.__pulseComponentReady&&o.setState(e):o.setState(e)}}}recordHistory(e,t){let s=null,i=null,n=null;if(0===this._actionProcessingStack.length&&"mutation"===e)return;if(this._actionProcessingStack.length>0){let e=this._actionProcessingStack[this._actionProcessingStack.length-1];i=e.id,s=e.name,e.parentAction&&(n=e.parentAction.id)}let o={type:e,timestamp:Date.now(),collection:this._name,fromAction:s,fromActionIdentifier:i,fromActionParentIdentifier:n,data:t};this._global.history.push(o)}populateDependencies(e,t){const s=this._global.dependencyGraph;for(let i=0;i<e.length;i++){const n=e[i],o=`${n.collection}/${n.property}`,r=s[this._name][t];r.dependencies.includes(o)||r.dependencies.push(o);const a=`${this._name}/${t}`,l=s[n.collection][n.property];l&&l.dependents&&!l.dependents.includes(a)&&l.dependents.push(a)}}checkForMissingDependency(e,t){const s=this._global;return!(!s.allFilters.includes(e.property)||s.generatedFilters.includes(e.collection+e.property))&&(Utils_1(`Dependent "${e.property}" has not been analysed yet, saving this filter to regen queue.`),this._regenQueue.push({type:"filter",property:t,collection:this._name}),!0)}findAllDependents(e){const t=this._global.dependencyGraph,s=t[this._name][e].dependents,i=[];let n=0,o=[];for(let e=0;e<s.length;e++){const t=s[e];o.push(t),i.push(t)}const r=()=>{n++;const e=o;o=[];for(let s=0;s<e.length;s++){const n=e[s],r=this.parseKey(n),a=t[r.collection][r.property].dependents;for(let e=0;e<a.length;e++){const t=a[e];o.push(t),i.push(t)}}if(n>1e3)return Utils_2("Maximum stack exceeded for dependent search.");0!==o.length&&r()};return r(),i}findAndUpdateDependents(e){let t=[];if(Array.isArray(e))for(let s=0;s<e.length;s++){const i=this.findAllDependents(e[s]);for(let e=0;e<i.length;e++){const s=i[e];t.includes(s)||t.push(s)}}else t=this.findAllDependents(e);Utils_1(`Found dependents: ${JSON.stringify(t)}`),this.pushDependentsToRegenQueue(t)}pushDependentsToRegenQueue(e){for(let t=0;t<e.length;t++){const{property:s,collection:i}=this.parseKey(e[t]);this._regenQueue.find(e=>e.property===s&&e.collection===i)||this._regenQueue.push({type:"filter",property:s,collection:i})}this.emitToRoot("processRegenQueue")}forceUpdate(e){this._filters.hasOwnProperty(e)?(this._regenQueue.push({type:"filter",property:e,collection:this._name}),this.emitToRoot("processRegenQueue")):this._mutableData.includes(e)&&(this.initDeepReactivity(this._public[e],e),this.updateSubscribers(e,this._public[e]),this.findAndUpdateDependents(e))}collect(e,t){if(!e)return Utils_2(`Collect error on collection ${this._name}: Data undefined`);Array.isArray(e)||(e=[e]),this._collecting=!0;const s=[],i=[];if(t)if(Array.isArray(t))for(let e=0;e<t.length;e++){const i=t[e];this.createRelationForIndex(i),this._indexesToRegen.push(i),this._indexes[i]||(this._indexes[i]=[]),s.push({indexName:i,previousValue:this._indexes[i]})}else this.createRelationForIndex(t),this._indexesToRegen.push(t),this._indexes[t]||(this._indexes[t]=[]),i.push(t);if(Array.isArray(e))for(let s=0;s<e.length;s++){const i=e[s];this.processDataItem(i,t,e)}else this.processDataItem(e,t);this.recordHistory("collect",{dataCollected:e,indexesCreated:i,indexesModified:s}),this._collecting=!1,Utils_1(`Collected ${e.length} items in ${this._name}. With index: ${t}`),this.regenerateGroupsAndFilters()}processDataItem(e,t){let s=!0;if(this._primaryKey||this.findPrimaryKey(e),null===e)return this.dataRejectionHandler(e,"Data cannot be null");if("object"!=typeof e)return this.dataRejectionHandler(e,`Collected data must be an object, but we recieved ${typeof e}`);for(let t=0;t<this._modelTypes.length;t++){let s=this._modelTypes[t],i=this._model[s].type;e[s]=this.validateDataPropertyAgainstType(e[s],i)}if(!e.hasOwnProperty(this._primaryKey))return this.dataRejectionHandler(e,"Primary key mismatch. ");let i=e[this._primaryKey],n=this._data[i];if(n&&(Object.keys(n).forEach(t=>{e.hasOwnProperty(t)||(e[t]=n[t])}),s=!1),t){Array.isArray(t)||(t=[t]);for(let e=0;e<t.length;e++){const s=t[e];this._indexes[s].includes(i)||this._indexes[s].push(i)}}const o=Object.keys(this._relations);for(let s=0;s<o.length;s++){const i=o[s],n=this._relations[i];Array.isArray(n[t])&&n[t].push(e[i])}Object.keys(this._data).includes(i)&&this.findGroupsToRegen(i),this.findFiltersToRegenFromRelatedData(i),this.findFiltersToRegenFromRelatedGroup(t),this._data[i]=e,s&&this._collectionSize++}validateDataPropertyAgainstType(e,t){switch(t){case"array":return Array.isArray(e)?e:[];case"string":return"string"==typeof e?e:"";case"boolean":return"boolean"==typeof e&&e;case"integer":case"number":return"number"==typeof e?e:0;case"object":return"object"==typeof e?e:{};default:return Utils_2(`Data validation failed. Type: "${t}" not supported`),null}}findGroupsToRegen(e){const t=Object.keys(this._indexes);for(let s=0;s<t.length;s++){const i=t[s];this._indexes[i].includes(e)&&!this._indexesToRegen.includes(i)&&this._indexesToRegen.push(i)}}findFiltersToRegenFromRelatedData(e){if(this._filtersRelatedToData[e])for(let t=0;t<this._filtersRelatedToData[e].length;t++){const s=this._filtersRelatedToData[e][t];this._filtersToForceRegen.includes(s)||this._filtersToForceRegen.push(s)}}findFiltersToRegenFromRelatedGroup(e){if(this._filtersRelatedToGroup[e])for(let t=0;t<this._filtersRelatedToGroup[e].length;t++){const s=this._filtersRelatedToGroup[e][t];this._filtersToForceRegen.includes(s)||this._filtersToForceRegen.push(s)}}regenerateGroupsAndFilters(){for(let e=0;e<this._indexesToRegen.length;e++){let t=this._indexesToRegen[e];Utils_1(`Rebuilding group "${t}" in collection "${this._name}"`),this.buildGroupFromIndex(t),this._global.dataRef[this._name][t]&&this.findAndUpdateDependents(t)}this._indexesToRegen=[];for(let e=0;e<this._filtersToForceRegen.length;e++){const t=this._filtersToForceRegen[e];this.pushDependentsToRegenQueue([`${this._name}/${t}`]),this.findAndUpdateDependents(t)}this._filtersToForceRegen=[]}undo(e,t,s){let i=this._global.history.filter(e=>e.fromActionIdentifier===t);if(this.emitToRoot("undo",i),s)throw s}move(e,t,s,i){if(!this._indexes[t])return Utils_2(`Index "${t}" not found`);if(!1!==s&&null!=s&&!this._indexes[s])return Utils_2(`Index "${s}" not found`);Array.isArray(e)||(e=[e]);let n={ids:e,fromIndex:t,toIndex:s,previousFromIndexValue:this._indexes[t],previousToIndexValue:this._indexes[s]};for(let n=0;n<e.length;n++){const o=e[n];if(!this._data[o])return Utils_2(`Data for id "${o}" not found in collection ${this._name}`);this._indexes[t]=this._indexes[t].filter(e=>e!==o),s&&("unshift"===i?this._indexes[s].unshift(o):this._indexes[s].push(o))}this.buildGroupFromIndex(t),s&&this.buildGroupFromIndex(s),this.recordHistory("move",n),s?this.findAndUpdateDependents([t,s]):this.findAndUpdateDependents([t])}remove(e,t){if(void 0!==t&&!this._indexes[t])return Utils_2(`Group "${t}" not found.`);if(!t)return this.delete(e);if(Array.isArray(e)||(e=[e]),"object"==typeof e[0]&&e[0].hasOwnProperty(this._primaryKey))e=e.map(e=>e[this._primaryKey]);else if("number"!=typeof e[0])return Utils_2("Unable to remove data.");let s=this._indexes[t].concat([]);this._indexes[t]=this._indexes[t].filter(t=>!e.includes(t)),this.buildGroupFromIndex(t),this.recordHistory("remove",{group:t,previousValue:s}),this.findAndUpdateDependents(t)}put(e,t,s){if(!this._indexes[t])return Utils_2(`Index "${t}" not found`);Array.isArray(e)||(e=[e]);let i=this._indexes[t].concat([]);for(let i=0;i<e.length;i++){const n=e[i];let o=[];o=this._indexes[t].includes(n)?this._indexes[t].filter(e=>e!=n):this._indexes[t],"unshift"===s?o.unshift(n):o.push(n),this._indexes[t]=o}this.buildGroupFromIndex(t),this.recordHistory("put",{group:t,ids:e,previousDestIndex:i}),this.findAndUpdateDependents(t)}update(e,t){if(this._data[e]){const s=this._data[e],i={dataId:e,previousValues:{},newValues:t},n=Object.keys(t);for(let e=0;e<n.length;e++){const o=n[e];i.previousValues[o]=s[o],s[o]=t[o]}this.recordHistory("update",i),this.internalDataModified(e)}else Utils_2(`Data for id "${e}" not found in collection ${this._name}`)}createRelationForFilterToData(e,t){Array.isArray(this._filtersRelatedToData[t])&&!this._filtersRelatedToData[t].includes(e)?this._filtersRelatedToData[t].push(e):this._filtersRelatedToData[t]=[e]}createRelationForFilterToGroup(e,t){Array.isArray(this._filtersRelatedToGroup[t])&&!this._filtersRelatedToGroup[t].includes(e)?this._filtersRelatedToGroup[t].push(e):this._filtersRelatedToGroup[t]=[e]}findById(e){if(this._executing&&this.createRelationForFilterToData(this._executing,e),this._data[e])return this._data[e];Utils_1(`findByID: Item "${e}" not found in collection "${this._name}"`)}getGroup(e){return this._executing&&this.createRelationForFilterToGroup(this._executing,e),this._indexes[e]?this.buildGroupFromIndex(e):[]}newGroup(e,t){Object.keys(this._indexes).includes(e)||(this._indexes[e]=t,this.recordHistory("newGroup",{createdGroup:e,data:t}))}modifyGroup(e){}delete(e){if(this._indexes[e])return Utils_2("Delete function only supports primary keys for data, if you're trying to delete a group, please use deleteGroup()");const t=e=>{let t=Object.assign({},this._data[e]);delete this._data[e],this.recordHistory("delete",{primaryKey:e,deleted:t})};if(Array.isArray(e))for(let s=0;s<e.length;s++){t(e[s])}else t(e);this.internalDataModified(e)}deleteGroup(e){if(!this._indexes[e])return Utils_2(`Group "${e}" not found.`);for(let t=0;t<this._indexes[e].length;t++){const s=this._indexes[e][t];this._data[s]&&delete this._data[s]}const t=this._indexes[e];this._indexes[e]=[],this.buildGroupFromIndex(e),this.recordHistory("deleteGroup",{group:e,previousValue:t}),this.findAndUpdateDependents(e)}purge(){this._data={};const e=Object.keys(this._indexes);for(let t=0;t<e.length;t++){const s=e[t];this._indexes[s]=[],this._indexesToRegen.push(s)}this.regenerateGroupsAndFilters()}clean(){}increment(e,t,s){this.validateNumberForDataProperty(e,t,s)&&(this._data[e][t]+=s,this.recordHistory("increment",{primaryKey:e,property:t,amount:s}),this.internalDataModified(e))}decrement(e,t,s){this.validateNumberForDataProperty(e,t,s)&&(this._data[e][t]-=s,this.recordHistory("decrement",{primaryKey:e,property:t,amount:s}),this.internalDataModified(e))}throttle(e){let t=this._performingAction;this._throttles.push(t),setTimeout(()=>{this._throttles=this._throttles.filter(e=>e!==t)},e)}set(e,t){}watch(e,t){if(!this._public[e])return Utils_2(`Error in watch function, property "${e}" does not exist`);this._internalWatchers[e]||(this._internalWatchers[e]=[]),this._internalWatchers[e].push(t)}validateNumberForDataProperty(e,t,s){return!(!this._data[e]||!this._data[e][t]||"number"!=typeof s||"number"!=typeof this._data[e][t])||(Utils_2(`Property ${t} for ${e} is not a number`),!1)}dataRejectionHandler(e,t){let s=`[Data Rejection] - ${t} - Data was not collected, but instead saved to the errors object("_errors") on root Pulse instance.`;this._global.errors.push({data:e,timestamp:new Date,error:s}),Utils_2(s)}parseKey(e){return{collection:e.split("/")[0],property:e.split("/")[1]}}}class Base extends Collection{constructor(e,{data:t={},actions:s={},routes:i={},filters:n={},groups:o=[],watch:r={},persist:a=[]}){t.isAuthenticated=!1,t.appReady=!1,a.push("isAuthenticated"),super({name:"base",global:e},{data:t,actions:s,groups:o,persist:a,routes:i,filters:n,watch:r})}}class Request extends Collection{constructor(e,{baseURL:t,requestIntercept:s,responseIntercept:i,mode:n,credentials:o,headers:r,saveHistory:a}){let l={baseURL:t,mode:"cors",credentials:"same-origin",headers:{Accept:"application/json"}};t||(l.baseURL=null),r&&Object.keys(r).forEach(e=>{l.headers[e]=r[e]}),o&&(l.credentials=o),n&&(l.mode=n),super({name:"request",global:e},{groups:[],data:l,persist:["baseURL"]}),this._requestIntercept=s,this._responseIntercept=i,this._saveHistory=void 0===this._saveHistory,this._global.request={get:this.get.bind(this),post:this.post.bind(this),put:this.put.bind(this),patch:this.patch.bind(this),delete:this.delete.bind(this),queryify:this.queryify.bind(this)}}send(e,t,s,i){return new Promise((n,o)=>{const r=Object.assign({},this._public.headers);let a;i&&Object.keys(i).forEach(e=>{r[e]=i[e]}),"get"!=t&&void 0===r["Content-Type"]&&(r["Content-Type"]="application/json"),a=e.startsWith("http")?e:`${this._global.dataRef.request.baseURL}/${e}`,s=JSON.stringify(s),this._options={},this._options.credentials=this._global.dataRef.request.credentials,this._options.mode=this._global.dataRef.request.mode;const l=Object.assign({headers:r,method:t.toUpperCase(),body:"get"==t?null:s},this._options);this._requestIntercept&&this._requestIntercept(this.getContextObject(),l),fetch(a,l).then(async e=>{const t=e.headers.get("content-type");let i;if(s=t&&-1!==t.indexOf("application/json")?await e.json():await e.text(),this._saveHistory||this.collect({id:Date.now(),status:e.status,timestamp:new Date,response:s}),Array.isArray(s)||"object"!=typeof s)i=s;else{i=Object.create({response:()=>e});const t=Object.keys(s);for(let e=0;e<t.length;e++){const n=t[e];i[n]=s[n]}}if(this._responseIntercept&&this._responseIntercept(this.getContextObject(),e),e.ok||e.redirected)return n(i);o(i)}).catch(o)})}get(e,t){return this.send(e,"get",{},t)}post(e,t,s){return this.send(e,"post",t,s)}patch(e,t,s){return this.send(e,"patch",t,s)}delete(e,t,s){return this.send(e,"delete",t,s)}put(e,t,s){return this.send(e,"put",t,s)}queryify(e){const t=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};return"object"!=typeof e?Utils_2("queryify error, object must be defined"):Object.keys(e).map(s=>{const i=encodeURIComponent(t(s))+"=";return Array.isArray(e[s])?e[s].map(e=>i+encodeURIComponent(t(e))).join("&"):i+encodeURIComponent(t(e[s]))}).join("&")}}class Pulse{constructor({storage:e,collections:t={},utils:s={},services:i={},staticData:n={},request:o={},data:r={},actions:a={},filters:l={},watch:h={},routes:c={},local:d={},groups:p=[],indexes:u=[],persist:_=[],config:g={}}){g.ssr||(window._pulse=this),this._collections={},this._subscribers=[],this._mappedProperties={},this._eventBus=this.activateEventBus(),this._global={componentStore:{},regenQueue:[],errors:[],history:[],allFilters:[],collectionNamespace:[],updateSubscribers:this.updateSubscribers,eventBus:this._eventBus,dependenciesFound:[],dependencyGraph:{},generatedFilters:[],record:!1,initComplete:!1,request:{},dataRef:{},internalDataRef:{},storage:{},relations:{},config:g},this.initStorage(e),this.initCollections(t,{data:r,indexes:u,actions:a,filters:l,routes:c,groups:p,watch:h,persist:_,local:d},o),this.utils=s,this.services=i,this.staticData=n,this.buildGlobalDataRefrenceTree(),this.prepareDependencyGraph(),this.executeAllFilters(),this.processRegenQueue(),this._global.initComplete=!0,this.runOnReadyHandlers()}unmount(e){e.__pulseUniqueIdentifier&&delete this._global.componentStore[e.__pulseUniqueIdentifier]}mount(e){this._global.componentStore[e.__pulseUniqueIdentifier]&&(this._global.componentStore[e.__pulseUniqueIdentifier].__pulseComponentReady=!0)}install(e){const t=window._pulse;let s=this;e.mixin({beforeCreate(){Object.keys(s._global.dataRef).forEach(e=>{this["$"+e]=s._global.dataRef[e]}),this.$utils=t.utils,this.$services=t.services,this.$staticData=t.staticData,this.mapData=s.mapData},mounted(){this.__pulseUniqueIdentifier&&(this.__pulseComponentReady=!0)},beforeDestroy(){this.__pulseUniqueIdentifier&&t.unmount(this)}})}mapData(e,t,s){t=t||this;const i={},n=window._pulse;return e&&n.normalizeMap(e).forEach(({key:o,val:r})=>{let a=Math.random().toString().split(".")[1]+Date.now();t.__pulseUniqueIdentifier=a,t.__pulseComponentReady=!s||!s.waitForMount,t.__pulseMappedData=e,n._global.componentStore[a]=t;let l=r.split("/")[0],h=r.split("/")[1];if(!n.hasOwnProperty(l))return;let c=n._collections[l]._subscribedToData,d={componentUUID:a,key:o};c.hasOwnProperty(h)?c[h].push(d):c[h]=[d],i[o]=n[l][h]}),i}mapCollections(){const e={};return Object.keys(this._global.dataRef).forEach(t=>{e[t]=this._global.dataRef[t]}),e}normalizeMap(e){return Array.isArray(e)?e.map(e=>({key:e,val:e})):Object.keys(e).map(t=>({key:t,val:e[t]}))}activateEventBus(){return new Proxy({message:null},{set:(e,t,s)=>("processRegenQueue"===s.type&&this.processRegenQueue(),"createForeignGroupRelation"===s.type&&(this._collections[s.data.foreignCollection]._foreignGroupRelations[s.data.foreignData]={collection:s.data.dependentCollection,groupToRegen:s.data.dependentGroup}),"rebuildGroupsWithRelations"===s.type&&this._collections[s.data.collection].buildGroupFromIndex(s.data.groupToRegen),"undo"===s.type&&this.processUndo(s.data),e[t]="waiting",!0)})}initStorage(e={}){let t="custom";if(e.async||(e.async=!1),"sessionStorage"===e)t="sessionStorage",this.assignStorage(sessionStorage,t,e.async);else if(e&&e.set&&e.get)t="custom",this.assignStorage(e,t,e.async);else{if(this._global.config.ssr||!window.localStorage)return Utils_2("No storage API present, data will not persist");t="localStorage",this.assignStorage(localStorage,t,e.async)}}assignStorage(e,t,s){const i={type:t,async:s};e.set&&(i.set=e.set.bind(e)),e.setItem&&(i.set=e.setItem.bind(e)),e.get&&(i.get=e.get.bind(e)),e.getItem&&(i.get=e.getItem.bind(e)),e.remove&&(i.remove=e.remove.bind(e)),e.removeItem&&(i.remove=e.removeItem.bind(e)),e.clear&&(i.clear=e.clear.bind(e)),this._global.storage=i}prepareDependencyGraph(){let e=this._global.dependencyGraph,t=this._global.collectionNamespace;for(let s=0;s<t.length;s++){const i=t[s];e[i]={};let n=this._collections[i]._public,o=[];const r=["filters","groups","data"];for(let e=0;e<r.length;e++){const t=r[e];Object.keys(n[t]).forEach(e=>o.push(e))}for(let t=0;t<o.length;t++){const s=o[t];e[i][s]={dependencies:[],dependents:[]}}}}initCollections(e,t,s){this._collections.base=new Base(this._global,t,s),this._collections.request=new Request(this._global,s),this._global.collectionNamespace=["base","request"],Object.keys(e).forEach(t=>{this._global.collectionNamespace.push(t),this._collections[t]=new Collection({name:t,global:this._global},e[t])}),Object.keys(this._collections).forEach(e=>{this[e]?Utils_2(`Collection name conflict, instance already has "${e}" thus it will not be accessable on the root state tree.`):this[e]=this._collections[e]._public})}buildGlobalDataRefrenceTree(){if(this._collections){const e=Object.keys(this._collections);for(let t=0;t<e.length;t++){const s=e[t];this._global.dataRef[s]=this._collections[s]._public}}}executeAllFilters(){const e=Object.keys(this._collections);for(let t=0;t<e.length;t++){const s=e[t];this._collections[s].analyseFilters()}}processRegenQueue(){if(0!==this._global.regenQueue.length){Utils_1(`Regen queue processing. There are ${this._global.regenQueue.length} in the queue.`);for(let e of this._global.regenQueue){const e=this._global.regenQueue.shift(),t=`${e.collection}/${e.property}`;if(t===this.lastRegenerated)return Utils_3(`Prevented infinate loop for ${t}`),void(this.lastRegenerated="");this._collections[e.collection].executeAndAnalyseFilter(e.property),this.lastRegenerated=t,Utils_1(`There are ${this._global.regenQueue.length} properties left to regenerate.`)}this._global.regenQueue.length>0?this.processRegenQueue():this.lastRegenerated=""}}runOnReadyHandlers(){const e=Object.keys(this._collections);for(let t=0;t<e.length;t++){this._collections[e[t]]._onReady()}}processUndo(e){for(let t=0;t<e.length;t++){const s=e[t],i=this._collections[s.collection],n=s.data;switch(s.type){case"mutation":case"collect":break;case"update":i.update(n.dataId,n.previousValues);break;case"put":i.replaceIndex(n.group,n.previousDestIndex);break;case"remove":i.replaceIndex(n.group,n.previousValue);break;case"move":i.replaceIndex(n.fromIndex,n.previousFromIndexValue),n.toIndex&&i.replaceIndex(n.toIndex,n.previousToIndexValue);break;case"delete":i._public[n.primaryKey]=n.deleted,i.internalDataModified(n.primaryKey),i.recordHistory("restore",{primaryKey:n.primaryKey,deleted:n.deleted});break;case"restore":i.delete(n.primaryKey);break;case"newGroup":i.deleteGroup(n.createdGroup);break;case"deleteGroup":i.newGroup(n.group,n.previousValue);break;case"indexMutation":i.replaceIndex(n.index,n.previousIndex);break;case"decrement":i.increment(s.data.primaryKey,s.data.property,s.data.amount);break;case"increment":i.decrement(s.data.primaryKey,s.data.property,s.data.amount)}}}}exports.Library=Pulse;
