"use strict";function __extends(t,e){function o(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}function __awaiter(t,e,o,i){return new(o||(o=Promise))(function(n,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){t.done?n(t.value):new o(function(e){e(t.value)}).then(s,a)}c((i=i.apply(t,e||[])).next())})}function __generator(t,e){function o(t){return function(e){return i([t,e])}}function i(o){if(n)throw new TypeError("Generator is already executing.");for(;c;)try{if(n=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return c.label++,{value:o[1],done:!1};case 5:c.label++,r=o[1],o=[0];continue;case 7:o=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===o[0]||2===o[0])){c=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){c.label=o[1];break}if(6===o[0]&&c.label<s[1]){c.label=s[1],s=o;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(o);break}s[2]&&c.ops.pop(),c.trys.pop();continue}o=e.call(t,c)}catch(t){o=[6,t],r=0}finally{n=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}var n,r,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a}function defineConfig(t,e){return __assign({},e,t)}function uuid(){return Math.random().toString().split(".")[1]+Date.now()}function objectLoop(t,e,o){for(var i=o||Object.keys(t),n=0;n<i.length;n++){var r=i[n];e(r,t[r],i)}}function isWatchableObject(t){var e=typeof t;return null!=t&&"object"==e&&!function(t){try{return t instanceof HTMLElement}catch(e){return"object"==typeof t&&1===t.nodeType&&"object"==typeof t.style&&"object"==typeof t.ownerDocument}}(t)&&!Array.isArray(t)}function log(t,e){}function normalizeMap(t){return Array.isArray(t)?t.map(function(t){return{key:t,val:t}}):Object.keys(t).map(function(e){return{key:e,val:t[e]}})}function cleanse(t){if(!isWatchableObject(t))return t;for(var e=Object.assign({},t),o=Object.keys(e),i=0;i<o.length;i++){var n=o[i];isWatchableObject(e[n])&&(e[n]=cleanse(e[n]))}return e}function assert(t,e){return t({NO_PRIMARY_KEY:function(){return!1},INVALID_PARAMETER:function(){return!1},INDEX_NOT_FOUND:function(){return!1},INTERNAL_DATA_NOT_FOUND:function(){return!1},PROPERTY_NOT_A_NUMBER:function(){return!1}})()}function validateNumber(t,e){return"number"==typeof e&&"number"==typeof t}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{},i=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(o).filter(function(t){return Object.getOwnPropertyDescriptor(o,t).enumerable}))),i.forEach(function(e){defineProperty(t,e,o[e])})}return t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,o){return e&&_defineProperties(t.prototype,e),o&&_defineProperties(t,o),t}function createCommonjsModule(t,e){return e={exports:{}},t(e,e.exports),e.exports}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof_1(e)&&"function"!=typeof e?assertThisInitialized(t):e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&setPrototypeOf(t,e)}function _extends(){return(_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i])}return t}).apply(this,arguments)}function withPulse(t,e,o,i){return function(n){function r(e){var o;return classCallCheck(this,r),o=possibleConstructorReturn(this,getPrototypeOf(r).call(this,e)),o.state=objectSpread({},t.mapData(i,assertThisInitialized(o),{waitForMount:!1!==t._private.global.config.waitForMount},t)),o}return inherits(r,n),createClass(r,[{key:"componentDidMount",value:function(){t._private.global.config.waitForMount&&t.mount(this)}},{key:"componentWillUnmount",value:function(){t._private.global.config.autoUnmount&&t.unmount(this)}},{key:"render",value:function(){return e.createElement(o,_extends({pulse:this.state},this.props))}}]),r}(e.Component)}var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)},__assign=function(){return(__assign=Object.assign||function(t){for(var e,o=1,i=arguments.length;o<i;o++){e=arguments[o];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t}).apply(this,arguments)},protectedNames=["data","indexes","groups","computed","actions","routes"],collectionFunctions=["collect","replaceIndex","getGroup","newGroup","deleteGroup","removeFromGroup","update","increment","decrement","delete","purge","watch","findById","put","move","throttle","forceUpdate","remove"],arrayFunctions=["push","pop","shift","unshift","splice","sort","reverse"],Dep=function(){function t(t,e,o,i,n){void 0===e&&(e="reactive"),void 0===n&&(n=null),this.global=t,this.type=e,this.colleciton=o,this.propertyName=i,this.rootProperty=n,this.dependents=new Set,this.subscribers=[],this.dynamicRelation=null}return t.prototype.register=function(){var t=this.global.subs;this.global.runningComputed&&this.dependents.add(this.global.runningComputed),this.global.runningPopulate&&this.global.relations.relate(this.global.runningPopulate,this),t.subscribingComponent&&this.subscribeComponent(),t.unsubscribingComponent},t.prototype.changed=function(){this.global.relations.cleanup(this.dynamicRelation)},t.prototype.subscribeComponent=function(){var t=this.global.subs;return this.rootProperty&&t.skimmingDeepReactive?void t.prepareNext(this):this.rootProperty?(t.foundDeepReactive(),void t.prepareNext(this)):(!this.rootProperty&&t.skimmingDeepReactive&&t.exitDeepReactive(),this.subscribe(),void t.prepareNext(this))},t.prototype.subscribe=function(){var t=this.global.subs,e=t.subscribingComponent.keys[t.subscribingComponentKey],o={componentUUID:t.subscribingComponent.componentUUID,key:e};this.subscribers.push(o)},t}(),Computed=function(){function t(t,e,o,i){this.global=t,this.collection=e,this.name=o,this.computedFunction=i,this.relatedToGroup=[],this.dynamicRelation=null}return t.prototype.run=function(){this.global.relations.cleanup(this.dynamicRelation),this.global.runningComputed=this;var t=this.computedFunction(this.global.getContext(this.collection));return void 0!==t&&null!==t||(t=!1),this.global.runningComputed=!1,t},t}(),DynamicRelation=function(){function t(t){this.updateThis=t,this.depsToClean=new Set}return t.prototype.destroy=function(){var t=this;this.depsToClean.forEach(function(e){return e.dependents.delete(t)}),delete this.updateThis.dynamicRelation},t}(),RelationController=function(){function t(t){this.global=t,this.relationBank=new Set}return t.prototype.relate=function(t,e){if(e){var o=e;t.dynamicRelation||(t.dynamicRelation=new DynamicRelation(t),this.relationBank.add(t.dynamicRelation)),t.dynamicRelation.depsToClean.add(o),o.dependents.add(t.dynamicRelation)}},t.prototype.cleanup=function(t){t&&(t.destroy(),this.relationBank.delete(t))},t}(),RelationTypes;!function(t){t.COMPUTED_DEPENDS_ON_DATA="COMPUTED_DEPENDS_ON_DATA",t.COMPUTED_DEPENDS_ON_GROUP="COMPUTED_DEPENDS_ON_GROUP",t.DATA_DEPENDS_ON_DEP="DATA_DEPENDS_ON_DEP",t.DATA_DEPENDS_ON_GROUP="DATA_DEPENDS_ON_GROUP",t.DATA_DEPENDS_ON_DATA="DATA_DEPENDS_ON_DATA"}(RelationTypes||(RelationTypes={}));var JobType;!function(t){t.PUBLIC_DATA_MUTATION="PUBLIC_DATA_MUTATION",t.INTERNAL_DATA_MUTATION="INTERNAL_DATA_MUTATION",t.INDEX_UPDATE="INDEX_UPDATE",t.COMPUTED_REGEN="COMPUTED_REGEN",t.GROUP_UPDATE="GROUP_UPDATE",t.SOFT_GROUP_UPDATE="SOFT_GROUP_UPDATE",t.DELETE_INTERNAL_DATA="DELETE_INTERNAL_DATA"}(JobType||(JobType={}));var Runtime=function(){function t(t,e){this.collections=t,this.global=e,this.running=!1,this.updatingSubscribers=!1,this.ingestQueue=[],this.completedJobs=[],this.archivedJobs=[],e.ingest=this.ingest.bind(this),e.ingestDependents=this.ingestDependents.bind(this),this.config=e.config}return t.prototype.ingest=function(t){this.ingestQueue.push(t),this.running||this.findNextJob()},t.prototype.findNextJob=function(){this.running=!0;var t=this.ingestQueue.shift();t.dep||t.type===JobType.INDEX_UPDATE||(t.dep=this.global.getDep(t.property,t.collection)),this.performJob(t)},t.prototype.performJob=function(t){switch(t.type){case JobType.PUBLIC_DATA_MUTATION:this.performPublicDataUpdate(t),this.collections[t.collection].runWatchers(t.property);break;case JobType.INTERNAL_DATA_MUTATION:this.performInternalDataUpdate(t);break;case JobType.INDEX_UPDATE:this.performIndexUpdate(t);break;case JobType.COMPUTED_REGEN:this.performComputedOutput(t),this.collections[t.collection].runWatchers(t.property.name);break;case JobType.GROUP_UPDATE:case JobType.SOFT_GROUP_UPDATE:this.performGroupRebuild(t),this.collections[t.collection].runWatchers(t.property);break;case JobType.DELETE_INTERNAL_DATA:this.performInternalDataDeletion(t)}t.dep&&t.dep.dependents.size>0&&this.ingestDependents(t.dep.dependents),this.finished()},t.prototype.ingestDependents=function(t){var e=this,o=function(t){return e.ingest({type:JobType.COMPUTED_REGEN,collection:t.collection,property:t,dep:e.global.getDep(t.name,t.collection)})};t.forEach(function(t){if(t instanceof Computed)o(t);else if(t instanceof DynamicRelation){var i=t.updateThis.constructor.name;i===Computed.name?o(t.updateThis):i===Dep.name&&e.ingest({type:JobType.INTERNAL_DATA_MUTATION,collection:t.updateThis.colleciton.name,property:t.updateThis.propertyName})}})},t.prototype.finished=function(){var t=this;if(this.running=!1,!(this.completedJobs.length>5e3))return this.ingestQueue.length>0?void this.findNextJob():void setTimeout(function(){0===t.ingestQueue.length?(t.updatingSubscribers||t.compileComponentUpdates(),t.cleanup()):t.findNextJob()})},t.prototype.performPublicDataUpdate=function(t){this.writeToPublicObject(t.collection,"data",t.property,t.value),this.completedJob(t)},t.prototype.performInternalDataUpdate=function(t){var e=this;t.value||this.collections[t.collection].internalData[t.property]&&(t.value=this.collections[t.collection].internalData[t.property]),t.previousValue=this.overwriteInternalData(t.collection,t.property,t.value),this.global.collecting||this.collections[t.collection].searchIndexesForPrimaryKey(t.property).forEach(function(o){var i=e.collections[t.collection].softUpdateGroupData(t.property,o);e.ingest({type:JobType.SOFT_GROUP_UPDATE,collection:t.collection,value:i,property:o,dep:e.global.getDep(o,t.collection)})}),this.completedJob(t)},t.prototype.performInternalDataDeletion=function(t){var e=this.collections[t.collection];t.previousValue=__assign({},e.internalData[t.property]),delete e.internalData[t.property];for(var o=this.collections[t.collection].searchIndexesForPrimaryKey(t.collection,t.property),i=0;i<o.length;i++){var n=o[i],r=e.indexes.object[n].slice().filter(function(e){return e!==t.property});this.ingest({type:JobType.INDEX_UPDATE,collection:e.name,property:n,value:r,dep:this.global.getDep(t.property,t.collection)})}this.completedJob(t)},t.prototype.performIndexUpdate=function(t){t.previousValue=this.collections[t.collection].indexes[t.property],this.collections[t.collection].indexes.privateWrite(t.property,t.value),this.completedJob(t),this.ingest({type:JobType.GROUP_UPDATE,collection:t.collection,property:t.property,dep:this.global.getDep(t.property,t.collection)})},t.prototype.performGroupRebuild=function(t){t.value||(t.value=this.collections[t.collection].buildGroupFromIndex(t.property)),this.writeToPublicObject(t.collection,"group",t.property,t.value),this.completedJob(t)},t.prototype.performComputedOutput=function(t){var e="string"==typeof t.property?this.collections[t.collection].computed[t.property]:t.property;t.value=e.run(),this.writeToPublicObject(t.collection,"computed",e.name,t.value),this.completedJob(t)},t.prototype.completedJob=function(t){t.fromAction=this.global.runningAction,this.global.initComplete&&this.completedJobs.push(t),this.persistData(t),t.dep&&t.dep.changed()},t.prototype.compileComponentUpdates=function(){if(this.global.initComplete){this.updatingSubscribers=!0,log("ALL JOBS COMPLETE",this.completedJobs);for(var t={},e=0;e<this.completedJobs.length;e++){var o=this.completedJobs[e];if(o.dep)for(var i=o.dep.subscribers,n=0;n<i.length;n++){var r=i[n].componentUUID,s=i[n].key;t[r]?t[r][s]=o.value:(t[r]={},t[r][s]=o.value)}}this.updateSubscribers(t),this.completedJobs=[]}},t.prototype.updateSubscribers=function(t){for(var e=Object.keys(t),o=this,i=0;i<e.length;i++){var n=function(i){var n=e[i],r=o.global.subs.componentStore[n];if(!r||!r.instance)return{value:void 0};var s=t[n],a=Object.keys(s);switch(o.global.config.framework){case"vue":a.forEach(function(t){var e=s[t];r.instance.$set(r.instance,t,cleanse(e))});break;case"react":r.instance.setState(s)}}(i);if("object"==typeof n)return n.value}},t.prototype.persistData=function(t){t.type!==JobType.INTERNAL_DATA_MUTATION&&this.collections[t.collection].persist.includes(t.property)&&this.global.storage.set(t.collection,t.property,t.value)},t.prototype.cleanup=function(){var t=this;setTimeout(function(){t.updatingSubscribers=!1})},t.prototype.writeToPublicObject=function(t,e,o,i){if("indexes"===e){if(!this.collections[t][e].object.hasOwnProperty(o))return;this.collections[t][e].privateWrite(o,i)}else{if(!this.collections[t].public.object.hasOwnProperty(o))return;this.collections[t].public.privateWrite(o,i)}},t.prototype.overwriteInternalData=function(t,e,o){var i=this.collections[t].internalData,n=!!i[e]&&__assign({},i[e]);if(n){for(var r=Object.keys(o||{}),s=0;s<r.length;s++){var a=r[s];i[e][a]=o[a]}return n}return i[e]=o,!1},t}(),Dep$1=function(){function t(t,e,o,i,n){void 0===e&&(e="reactive"),void 0===n&&(n=null),this.global=t,this.type=e,this.colleciton=o,this.propertyName=i,this.rootProperty=n,this.dependents=new Set,this.subscribers=[],this.dynamicRelation=null}return t.prototype.register=function(){var t=this.global.subs;this.global.runningComputed&&this.dependents.add(this.global.runningComputed),this.global.runningPopulate&&this.global.relations.relate(this.global.runningPopulate,this),t.subscribingComponent&&this.subscribeComponent(),t.unsubscribingComponent},t.prototype.changed=function(){this.global.relations.cleanup(this.dynamicRelation)},t.prototype.subscribeComponent=function(){var t=this.global.subs;return this.rootProperty&&t.skimmingDeepReactive?void t.prepareNext(this):this.rootProperty?(t.foundDeepReactive(),void t.prepareNext(this)):(!this.rootProperty&&t.skimmingDeepReactive&&t.exitDeepReactive(),this.subscribe(),void t.prepareNext(this))},t.prototype.subscribe=function(){var t=this.global.subs,e=t.subscribingComponent.keys[t.subscribingComponentKey],o={componentUUID:t.subscribingComponent.componentUUID,key:e};this.subscribers.push(o)},t}(),Reactive=function(){function t(t,e,o,i,n){void 0===t&&(t={}),this.global=e,this.collection=o,this.mutable=i,this.type=n,this.allowPrivateWrite=!1,this.touching=!1,this.tempDeps={},this.dispatch=this.global.dispatch,this.properties=Object.keys(t),this.object=this.reactiveObject(t)}return t.prototype.reactiveObject=function(t,e){for(var o=Object.keys(t),i=0;i<o.length;i++){var n=o[i];this.defineProperty(t,n,e)}return t},t.prototype.defineProperty=function(t,e,o){var i=this,n=t[e];t.rootProperty&&(o=t.rootProperty),isWatchableObject(n)&&!protectedNames.includes(e)&&(n=this.deepReactiveObject(n,o||e,e));var r=this.createDep(e,o);return Object.defineProperty(t,e,{get:function(){return i.sneaky?n:i.global.touching?(i.global.touched=r,n):(r.register(),n)},set:function(t){if(o&&i.mutable.includes(o))n=t,i.dispatch("mutation",{collection:i.collection.name,key:o,value:i.object[o],dep:r});else{if(protectedNames.includes(e))return n=t;if(i.allowPrivateWrite)return isWatchableObject(n)&&i.mutable.includes(e)&&(t=i.deepReactiveObject(t,o||e,e)),n=t;i.mutable.includes(e)&&i.dispatch("mutation",{collection:i.collection.name,key:e,value:t,dep:r})}}}),t},t.prototype.addProperty=function(t,e){this.object[t]=e,this.defineProperty(this.object,t)},t.prototype.tempDep=function(t){var e=this.createDep(t);return this.tempDeps[t]=e,e},t.prototype.cloneDep=function(t){return t=Object.assign(Object.create(Object.getPrototypeOf(t)),t)},t.prototype.createDep=function(t,e){return this.tempDeps.hasOwnProperty(t)&&!e?this.cloneDep(this.tempDeps[t]):new Dep$1(this.global,"indexes"===this.type?"index":"reactive",this.collection,t,e)},t.prototype.deepReactiveObject=function(t,e,o){for(var i=Object.create({rootProperty:e,propertyName:o}),n=Object.keys(t),r=0;r<n.length;r++){var s=n[r];i[s]=t[s]}this.allowPrivateWrite=!0;var a=this.reactiveObject(i,e);return this.allowPrivateWrite=!1,a},t.prototype.reactiveArray=function(t,e){for(var o=this,i=t.slice(),n=0;n<arrayFunctions.length;n++)!function(t){var n=arrayFunctions[t],r=Array.prototype[n];Object.defineProperty(i,n,{value:function(){var t=r.apply(this,arguments);return o.global.initComplete&&o.dispatch("mutation",{collection:o.collection.name,key:e,value:t}),t}})}(n);return i},t.prototype.privateWrite=function(t,e){this.allowPrivateWrite=!0,this.object[t]=e,this.allowPrivateWrite=!1},t.prototype.privateGet=function(t){this.sneaky=!0;var e=this.object[t];return this.sneaky=!1,e},t.prototype.exists=function(t){this.sneaky=!0;var e=!!this.object.hasOwnProperty(t);return this.sneaky=!1,e},t.prototype.getKeys=function(){this.sneaky=!0;var t=Object.keys(this.object);return this.sneaky=!1,t},t}(),Action=function(){function t(t,e,o,i){this.collection=t,this.global=e,this.action=o,this.actionName=i,this.executing=!1,this.uuid=uuid(),this.prepare(o,e,this.global.contextRef.undo)}return t.prototype.prepare=function(t,e,o){var i=this;this.exec=function(){var n=this,r=e.getContext(i.collection);r.undo=function(t){return o(n.actionName,n.uuid,t)},e.runningAction=i,i.executing=!0;var s=t.apply(null,[r].concat(Array.prototype.slice.call(arguments)));return i.executing=!1,e.runningAction=!1,s}},t}(),Collection=function(){function t(t,e,o){this.name=t,this.global=e,this.config={},this.keys={},this.methods={},this.actions={},this.computed={},this.watchers={},this.externalWatchers={},this.persist=[],this.local={},this.model={},this.collectionSize=0,this.primaryKey=!1,this.internalData={},this.internalDataDeps={},this.internalDataWithPopulate=[],this.config=o.config,this.dispatch=this.global.dispatch,o.computed=__assign({},o.computed,o.filters),o=this.prepareNamespace(o),this.initReactive(o.data,o.groups),this.initRoutes(o.routes),this.initActions(o.actions),this.initWatchers(o.watch),this.initComputed(o.computed),this.initModel(o.model),this.initPersist(o.persist)}return t.prototype.prepareNamespace=function(t){var e=this;return collectionFunctions.map(function(t){return e.methods[t]=e[t].bind(e)}),t.local&&(this.local=t.local),["data","actions","computed","indexes","routes","watch"].forEach(function(o){"indexes"===o||t[o]||(t[o]={}),e.keys[o]="indexes"===o?t.groups||[]:Object.keys(t[o])}),this.namespace=Object.assign(Object.create(__assign({},this.methods)),__assign({routes:{},indexes:{},actions:t.actions},t.computed,t.data,this.normalizeGroups(t.groups))),t},t.prototype.normalizeGroups=function(t){void 0===t&&(t=[]);for(var e={},o=0;o<t.length;o++)e[t[o]]=[];return e},t.prototype.runWatchers=function(t){var e=this.watchers[t];e&&e();var o=this.externalWatchers[t];o&&o.forEach(function(t){return"function"==typeof t&&t()})},t.prototype.initReactive=function(t,e){void 0===e&&(e=[]),e=this.normalizeGroups(e),this.indexes=new Reactive(e,this.global,this,this.keys.indexes,"indexes"),this.namespace.indexes=this.indexes.object,this.public=new Reactive(this.namespace,this.global,this,this.keys.data.concat(this.keys.indexes),"root")},t.prototype.initPersist=function(t){var e=this;if(Array.isArray(t))for(var o=this,i=0;i<t.length;i++)!function(i){var n=t[i];if(o.persist.push(n),o.global.storage.isPromise)o.global.storage.get(o.name,n).then(function(t){if(void 0!==t&&null!==t){var o={type:JobType.PUBLIC_DATA_MUTATION,value:t,property:n,collection:e.name,dep:e.global.getDep(n,e.name)};e.global.ingest(o)}});else{var r=o.global.storage.get(o.name,n);if(void 0===r||null===r)return"continue";o.public.privateWrite(n,r)}}(i)},t.prototype.initActions=function(t){void 0===t&&(t={});for(var e=Object.keys(t),o=0;o<e.length;o++){var i=t[e[o]];this.actions[e[o]]=new Action(this.name,this.global,i,e[o]),this.public.privateWrite(e[o],this.actions[e[o]].exec)}},t.prototype.initWatchers=function(t){var e=this;void 0===t&&(t={});for(var o=Object.keys(t),i=this,n=0;n<o.length;n++)!function(n){var r=t[o[n]];i.watchers[o[n]]=function(){e.global.runningWatcher={collection:e.name,property:o[n]};var t=r(e.global.getContext(e.name));return e.global.runningWatcher=!1,t}}(n);this.watchers._keys=o},t.prototype.initComputed=function(t){var e=this;objectLoop(t,function(t,o){e.computed[t]=new Computed(e.global,e.name,t,o),e.public.object[t]=[]},this.keys.computed)},t.prototype.initRoutes=function(t){var e=this,o=this,i=function(e){return function(){var i=Object.assign({},o.global.request);return i.context=o.global.getContext(),t[e].apply(null,[i].concat(Array.prototype.slice.call(arguments)))}};objectLoop(t,function(t){return e.public.object.routes[t]=i(t)})},t.prototype.initModel=function(t){var e=this;void 0===t&&(t={}),this.model=t,Object.keys(t).forEach(function(o){Object.keys(t[o]).forEach(function(t){switch(t){case"primaryKey":e.primaryKey=o;break;case"populate":e.internalDataWithPopulate.push(o)}})})},t.prototype.getData=function(t){return __assign({},this.internalData[t])},t.prototype.buildGroupFromIndex=function(t){var e=[],o=this.indexes.privateGet(t);if(!o)return[];for(var i=0;i<o.length;i++){var n=o[i],r=this.getData(n);r&&(r=this.injectDynamicRelatedData(n,r),e.push(r))}return e},t.prototype.softUpdateGroupData=function(t,e){var o=this.indexes.privateGet(e).indexOf(t);if(!this.public[e])return this.buildGroupFromIndex(e);var i=[this.public[e]],n=__assign({},this.internalData[t]);return n=this.injectDynamicRelatedData(t,n),i[o]=n,i},t.prototype.injectDynamicRelatedData=function(t,e){var o=this;return this.internalDataWithPopulate.forEach(function(i){var n=o.global.getDep(t,o.name,!0);o.global.runningPopulate=n;var r=o.model[i].populate(o.global.getContext(),e);o.global.runningPopulate=!1,e[i]=r}),e},t.prototype.createGroups=function(t){void 0===t?t=[]:Array.isArray(t)||(t=[t]);for(var e=0;e<t.length;e++){var o=t[e];this.indexes.exists(o)||this.indexes.addProperty(o,[])}return t},t.prototype.collect=function(t,e,o){var i=this;o=defineConfig(o,{append:!0}),this.global.collecting=!0,Array.isArray(t)||(t=[t]);for(var n=this.createGroups(e),r=this.getPreviousIndexValues(n),s=new Set,a=0;a<t.length;a++){var c=t[a];if(null!==c){var p=this.processDataItem(c,n,o);p&&(p.success&&this.collectionSize++,p.affectedIndexes.forEach(function(t){return s.add(t)}))}}s.forEach(function(t){i.global.ingest({type:JobType.INDEX_UPDATE,collection:i.name,property:t,value:i.indexes.privateGet(t),previousValue:r[t],dep:i.global.getDep(t,i.indexes.object)})}),this.global.collecting=!1},t.prototype.processDataItem=function(t,e,o){if(void 0===e&&(e=[]),this.primaryKey||this.findPrimaryKey(t),!this.primaryKey)return!1;var i=t[this.primaryKey],n=e.slice();this.searchIndexesForPrimaryKey(i).map(function(t){return!n.includes(t)&&n.push(t)}),this.internalDataDeps[i]||(this.internalDataDeps[i]=new Dep$1(this.global,"internal",this,i)),this.global.ingest({type:JobType.INTERNAL_DATA_MUTATION,collection:this.name,property:i,value:t,dep:this.internalDataDeps[i]});for(var r=0;r<e.length;r++){var s=e[r],a=this.indexes.privateGet(s);a=a.filter(function(t){return t!=i}),o.append?a.push(i):a.unshift(i),this.indexes.privateWrite(s,a)}return{success:!0,affectedIndexes:n}},t.prototype.searchIndexesForPrimaryKey=function(t){for(var e=this.indexes.getKeys(),o=[],i=0;i<e.length;i++){var n=e[i];this.indexes.privateGet(n).includes(t)&&o.push(n)}return o},t.prototype.getPreviousIndexValues=function(t){for(var e={},o=0;o<t;o++){var i=t[o];e[i]=this.indexes.privateGet(i)}return e},t.prototype.findPrimaryKey=function(t){return t.hasOwnProperty("id")?this.primaryKey="id":t.hasOwnProperty("_id")?this.primaryKey="_id":t.hasOwnProperty("key")&&(this.primaryKey="key"),!!this.primaryKey||assert(function(t){return t.NO_PRIMARY_KEY})},t.prototype.replaceIndex=function(t,e){if(!Array.isArray(e)||"string"!=typeof t)return assert(function(t){return t.INVALID_PARAMETER});this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:t,value:e})},t.prototype.depForInternalData=function(t){var e;return this.internalDataDeps[t]?e=this.internalDataDeps[t]:(e=new Dep$1(this.global,"internal",this,t),this.internalDataDeps[t]=e),e},t.prototype.depForGroup=function(t){return this.public.exists(t)?this.global.getDep(t,this.name):this.indexes.exists(t)?this.global.getDep(t,this.indexes.object):this.indexes.tempDep(t)},t.prototype.findById=function(t){var e=this.depForInternalData(t);if(this.global.runningComputed){var o=this.global.runningComputed;this.global.relations.relate(o,e)}if(this.global.runningPopulate){var i=this.global.runningPopulate;this.global.relations.relate(i,e)}return this.internalData[t]},t.prototype.getGroup=function(t){var e=this.depForGroup(t);if(this.global.runningComputed){var o=this.global.runningComputed;this.global.relations.relate(o,e)}if(this.global.runningPopulate){var i=this.global.runningPopulate;this.global.relations.relate(i,e)}return this.buildGroupFromIndex(t)||[]},t.prototype.undo=function(){},t.prototype.throttle=function(){},t.prototype.move=function(t,e,o,i){if(void 0===i&&(i="push"),!this.indexes.exists(e))return assert(function(t){return t.INDEX_NOT_FOUND});if(o&&!this.indexes.exists(o))return assert(function(t){return t.INDEX_NOT_FOUND});Array.isArray(t)||(t=[t]);for(var n=this.indexes.privateGet(e),r=0;r<t.length;r++)!function(e){n=n.filter(function(o){return o!==t[e]})}(r);if(this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:e,value:n}),o){for(var s=this.indexes.privateGet(o),r=0;r<t.length;r++)s.includes(t[r])||s[i](t[r]);this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:o,value:s})}},t.prototype.put=function(t,e,o){if(void 0===o&&(o="push"),!this.indexes.exists(e))return assert(function(t){return t.INDEX_NOT_FOUND});Array.isArray(t)||(t=[t]);for(var i=this.indexes.privateGet(e),n=0;n<t.length;n++)i.includes(t[n])||i[o](t[n]);this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:e,value:i})},t.prototype.newGroup=function(t,e){if(this.indexes.object.hasOwnProperty(t))return assert(function(t){return t.GROUP_ALREADY_EXISTS});this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:t,value:e})},t.prototype.deleteGroup=function(t){this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:t,value:[]})},t.prototype.removeFromGroup=function(t,e){if(!this.indexes.exists(t))return assert(function(t){return t.INDEX_NOT_FOUND});Array.isArray(e)||(e=[e]);var o=this.indexes.privateGet(t).filter(function(t){return!e.includes(t)});this.global.ingest({type:JobType.INDEX_UPDATE,collection:this.name,property:t,value:o})},t.prototype.update=function(t,e){if(!this.internalData.hasOwnProperty(t))return assert(function(t){return t.INTERNAL_DATA_NOT_FOUND});for(var o=Object.keys(e),i=Object.assign({},this.internalData[t]),n=0;n<o.length;n++){var r=o[n];i[r]=e[r]}this.global.ingest({type:JobType.INTERNAL_DATA_MUTATION,collection:this.name,property:t,value:i})},t.prototype.increment=function(t,e,o,i){if(!this.internalData.hasOwnProperty(t))return assert(function(t){return t.INTERNAL_DATA_NOT_FOUND});var n=Object.assign({},this.internalData[t]);if(!validateNumber(o,n[e]))return assert(function(t){return t.PROPERTY_NOT_A_NUMBER});i?n[e]-=o:n[e]+=o,this.global.ingest({type:JobType.INTERNAL_DATA_MUTATION,collection:this.name,property:t,value:n})},t.prototype.decrement=function(t,e,o){this.increment(t,e,o,!0)},t.prototype.delete=function(t){Array.isArray(t)||(t=[t]);for(var e=0;e<t.length;e++){var o=t[e];this.global.ingest({type:JobType.DELETE_INTERNAL_DATA,collection:this.name,property:o})}},t.prototype.purge=function(){},t.prototype.watch=function(t,e){this.externalWatchers[t]?this.externalWatchers[t].push(e):this.externalWatchers[t]=[e]},t.prototype.forceUpdate=function(t){this.public.exists(t)&&(this.public.mutable.includes(t)?this.global.ingest({type:JobType.PUBLIC_DATA_MUTATION,property:t,collection:this.name,value:this.public.privateGet(t),dep:this.global.getDep(t,this.name)}):this.computed[t]&&this.global.ingest({type:JobType.COMPUTED_REGEN,property:t,collection:this.name,dep:this.global.getDep(t,this.name)}))},t.prototype.remove=function(t,e){return this.removeFromGroup(e,t)},t}(),SubController=function(){function t(t){this.getContext=t,this.subscribingComponentKey=0,this.subscribingComponent=!1,this.unsubscribingComponent=!1,this.skimmingDeepReactive=!1,this.uuid=uuid,this.lastAccessedDep=null,this.componentStore={}}return t.prototype.registerComponent=function(t,e){var o=t.__pulseUniqueIdentifier;if(o)this.mount(t);else{var i={instance:t,uuid:o=this.uuid(),ready:!e.waitForMount};t.__pulseUniqueIdentifier=o,this.componentStore[o]=i}return o},t.prototype.mount=function(t){var e=this.componentStore[t.__pulseUniqueIdentifier];e&&(e.instance=t,e.ready=!0)},t.prototype.unmount=function(t){t.__pulseUniqueIdentifier&&delete this.componentStore[t.__pulseUniqueIdentifier]},t.prototype.subscribePropertiesToComponents=function(t,e){var o=t(this.getContext()),i=Object.keys(o);this.subscribingComponentKey=0,this.subscribingComponent={componentUUID:e,keys:i};var n=t(this.getContext());return this.subscribingComponent=!1,this.subscribingComponentKey=0,n},t.prototype.prepareNext=function(t){this.lastAccessedDep=t,this.skimmingDeepReactive||this.subscribingComponentKey++},t.prototype.foundDeepReactive=function(){this.skimmingDeepReactive=!0,this.lastAccessedDep.subscribers.pop(),this.subscribingComponentKey--},t.prototype.exitDeepReactive=function(){this.skimmingDeepReactive=!1,this.lastAccessedDep.subscribe(),this.subscribingComponentKey++},t}(),Storage=function(){function t(t){void 0===t&&(t={}),this.storageMethods=t,this.isPromise=!1,this.storageReady=!1,this.storageType="localStorage",t.async&&(this.isPromise=!0),(t.get||t.set||t.remove)&&(this.storageType="custom"),this.localStorageAvaliable()&&"localStorage"===this.storageType?(this.storageReady=!0,t.get=localStorage.getItem.bind(localStorage),t.set=localStorage.setItem.bind(localStorage),t.remove=localStorage.removeItem.bind(localStorage)):(this.storageType="custom",this.check(t.get)&&this.check(t.set)&&this.check(t.remove)?this.storageReady=!0:this.storageReady=!1)}return t.prototype.get=function(t,e){var o=this;if(this.storageReady)return this.isPromise?new Promise(function(i,n){o.storageMethods.get(o.getKey(t,e)).then(function(t){if("string"!=typeof t)return i(t);i(JSON.parse(t))}).catch(n)}):JSON.parse(this.storageMethods.get(this.getKey(t,e)))},t.prototype.set=function(t,e,o){this.storageReady&&this.storageMethods.set(this.getKey(t,e),JSON.stringify(o))},t.prototype.remove=function(t,e){this.storageReady&&this.storageMethods.remove(this.getKey(t,e))},t.prototype.getKey=function(t,e){return"_"+t+"_"+e},t.prototype.check=function(t){return"function"==typeof t},t.prototype.localStorageAvaliable=function(){try{return localStorage.setItem("_","_"),localStorage.removeItem("_"),!0}catch(t){return!1}},t}(),Request=function(t){function e(e,o){var i=this,n=[],r=["baseURL"],s={baseURL:o.baseURL||"",mode:"cors",credentials:"same-origin",headers:{Accept:"application/json"}};return o.headers&&Object.keys(o.headers).forEach(function(t){s.headers[t]=o.headers[t]}),o.credentials&&(s.credentials=o.credentials),o.mode&&(s.mode=o.mode),i=t.call(this,"request",e,{groups:n,data:s,persist:r})||this,i.requestIntercept=o.requestIntercept,i.responseIntercept=o.responseIntercept,i.timeout=o.timeout,i.saveHistory=void 0===o.saveHistory,i.global.request={get:i.get.bind(i),post:i.post.bind(i),put:i._put.bind(i),patch:i.patch.bind(i),delete:i.delete.bind(i),queryify:i.queryify.bind(i)},i}return __extends(e,t),e.prototype.get=function(t,e){return this.send(t,"get",{},e)},e.prototype.post=function(t,e,o){return this.send(t,"post",e,o)},e.prototype._put=function(t,e,o){return this.send(t,"put",e,o)},e.prototype.patch=function(t,e,o){return this.send(t,"patch",e,o)},e.prototype.delete=function(t,e,o){return this.send(t,"delete",e,o)},e.prototype.send=function(t,e,o,i){return void 0===o&&(o={}),__awaiter(this,void 0,void 0,function(){var n,r,s,a,c,p,l,u,h,f=this;return __generator(this,function(y){switch(y.label){case 0:return n=Object.assign({},this.public.object.headers),i&&Object.keys(i).forEach(function(t){n[t]=i[t]}),"get"!==e&&void 0===n["Content-Type"]&&(n["Content-Type"]="application/json"),r=t.startsWith("http")?t:this.public.object.baseURL+"/"+t,o=JSON.stringify(o),this.options={},this.options.credentials=this.public.object.credentials,this.options.mode=this.public.object.mode,s=Object.assign({headers:n,method:e.toUpperCase(),body:"get"===e?null:o},this.options),this.requestIntercept&&this.requestIntercept(this.global.getContext("request"),s),this.timeout?[4,Promise.race([fetch(r,s),new Promise(function(t,e){return setTimeout(function(){return e("timeout")},f.timeout)})])]:[3,2];case 1:return a=y.sent(),[3,4];case 2:return[4,fetch(r,s)];case 3:a=y.sent(),y.label=4;case 4:return c=a.headers.get("content-type"),c&&-1!==c.indexOf("application/json")?[4,a.json()]:[3,6];case 5:return o=y.sent(),[3,8];case 6:return[4,a.text()];case 7:o=y.sent(),y.label=8;case 8:if(this.saveHistory||this.collect({id:Date.now(),status:a.status,timestamp:new Date,response:o}),Array.isArray(o)||"object"!=typeof o)p=o;else for(p=Object.create({response:function(){return a}}),l=Object.keys(o),u=0;u<l.length;u++)h=l[u],p[h]=o[h];if(this.responseIntercept&&(a.data=o,this.responseIntercept(this.global.getContext("request"),a)),a.ok||a.redirected)return[2,p];throw p}})})},e.prototype.queryify=function(t){var e=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}};if("object"==typeof t)return Object.keys(t).map(function(o){var i=encodeURIComponent(e(o))+"=";return Array.isArray(t[o])?t[o].map(function(t){return i+encodeURIComponent(e(t))}).join("&"):i+encodeURIComponent(e(t[o]))}).join("&")},e}(Collection),Request$1=function(t){function e(e,o){void 0===o&&(o={});return o=Object.assign({},o),delete o.collections,delete o.request,o.data||(o.data={}),o.persist||(o.persist=[]),o.data.isAuthenticated=!1,o.persist.push("isAuthenticated"),o.data.appReady=!1,t.call(this,"base",e,o)||this}return __extends(e,t),e}(Collection),defineProperty=_defineProperty,objectSpread=_objectSpread,classCallCheck=_classCallCheck,createClass=_createClass,_typeof_1=createCommonjsModule(function(t){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(i){return"function"==typeof Symbol&&"symbol"===e(Symbol.iterator)?t.exports=o=function(t){return e(t)}:t.exports=o=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":e(t)},o(i)}t.exports=o}),assertThisInitialized=_assertThisInitialized,possibleConstructorReturn=_possibleConstructorReturn,getPrototypeOf=createCommonjsModule(function(t){function e(o){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(o)}t.exports=e}),setPrototypeOf=createCommonjsModule(function(t){function e(o,i){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},e(o,i)}t.exports=e}),inherits=_inherits,Library=function(){function t(t){var e=this;void 0===t&&(t={}),this._private={runtime:null,events:{},collections:{},collectionKeys:[],global:{config:this.prepareConfig(t.config),initComplete:!1,runningAction:!1,runningWatcher:!1,runningComputed:!1,runningPopulate:!1,mappingData:!1,collecting:!1,touching:!1,touched:!1,contextRef:{},subs:new SubController(this.getContext.bind(this)),relations:null,storage:null,dispatch:this.dispatch.bind(this),getInternalData:this.getInternalData.bind(this),getContext:this.getContext.bind(this),getDep:this.getDep.bind(this),uuid:uuid}},["utils","services","staticData"].forEach(function(o){t[o]&&(e[o]=t[o])}),this._private.global.storage=new Storage(t.storage),this._private.global.relations=new RelationController(this._private.global),this.initCollections(t),this.initRuntime(),this.bindCollectionPublicData(),this.runAllComputed(),this.initComplete()}return t.prototype.initCollections=function(t){if(this._private.collectionKeys=[],t.collections){this._private.collectionKeys=Object.keys(t.collections).concat(this._private.collectionKeys);for(var e=0;e<this._private.collectionKeys.length;e++)this._private.collections[this._private.collectionKeys[e]]=new Collection(this._private.collectionKeys[e],this._private.global,t.collections[this._private.collectionKeys[e]])}!1!==this._private.global.config.enableRequest&&this._private.collectionKeys.push("request"),this._private.collections.request=new Request(this._private.global,t.request||{}),!1!==this._private.global.config.enableBase&&(this._private.collectionKeys.push("base"),this._private.collections.base=new Request$1(this._private.global,t))},t.prototype.initRuntime=function(){this._private.runtime=new Runtime(this._private.collections,this._private.global)},t.prototype.bindCollectionPublicData=function(){for(var t=0;t<this._private.collectionKeys.length;t++){var e=this._private.collections[this._private.collectionKeys[t]];this._private.global.contextRef[this._private.collectionKeys[t]]=e.public.object,this[this._private.collectionKeys[t]]=e.public.object}},t.prototype.runAllComputed=function(){for(var t=0;t<this._private.collectionKeys.length;t++)for(var e=this._private.collections[this._private.collectionKeys[t]],o=e.keys.computed,i=0;i<o.length;i++){var n=o[i];this._private.runtime.performComputedOutput({collection:e.name,property:n,type:JobType.COMPUTED_REGEN}),e.runWatchers(n)}},t.prototype.initComplete=function(){if(this._private.global.initComplete=!0,log("INIT COMPLETE",Object.assign({},this)),!this._private.global.config.ssr)try{window._pulse=this}catch(t){}},t.prototype.wrapped=function(t,e){var o=this._private.global.config;return!("react"!==o.framework||!o.frameworkConstructor)&&withPulse(this,o.frameworkConstructor,t,e)},t.prototype.prepareConfig=function(t){return(t=defineConfig(t,{framework:null,waitForMount:!1,autoUnmount:!1})).framework&&t.framework.hasOwnProperty("__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED")&&(t.frameworkConstructor=t.framework,t.framework="react"),"react"===t.framework&&(0!=t.waitForMount&&(t.waitForMount=!0),0!=t.autoUnmount&&(t.autoUnmount=!0)),t},t.prototype.getInternalData=function(t,e){return this._private.collections[t].findById(e)},t.prototype.getDep=function(t,e,o){var i;return o?i=this._private.collections[e].internalDataDeps[t]:(this._private.global.touching=!0,"string"==typeof e?this._private.collections[e].public.object[t]:"object"==typeof e&&e[t],i=this._private.global.touched,this._private.global.touching=!1,this._private.global.touched=null,i||(i=this._private.collections[e].internalDataDeps[t])),i},t.prototype.dispatch=function(t,e){switch(t){case"mutation":this._private.runtime.ingest({type:JobType.PUBLIC_DATA_MUTATION,collection:e.collection,property:e.key,value:e.value,dep:e.dep})}},t.prototype.getContext=function(t){var e=this._private.collections[t];return e?__assign({},this._private.global.contextRef,e.methods,{data:e.public.object,indexes:e.indexes.object,groups:e.public.object,computed:e.public.object,routes:e.public.object.routes,local:e.local}):this._private.global.contextRef},t.prototype.install=function(t){this._private.global.config.framework="vue";var e=this,o=e._private.global.config;t.mixin({beforeCreate:function(){var t=this;Object.keys(e._private.global.contextRef).forEach(function(o){t["$"+o]=e._private.global.contextRef[o]}),e.utils&&(this.$utils=e.utils),e.services&&(this.$services=e.services),e.staticData&&(this.$staticData=e.staticData),this.mapData=function(i){return e.mapData(i,t,{waitForMount:o.waitForMount},e)}},mounted:function(){this.__pulseUniqueIdentifier&&o.waitForMount&&e.mount(this)},beforeDestroy:function(){this.__pulseUniqueIdentifier&&o.autoUnmount&&e.unmount(this)}})},t.prototype.mount=function(t){this._private.global.subs.mount(t)},t.prototype.unmount=function(t){this._private.global.subs.unmount(t)},t.prototype.mapData=function(t,e,o,i){void 0===e&&(e={}),void 0===o&&(o={});var n=i||this,r=__assign({waitForMount:!0},o),s=n._private.global.subs.registerComponent(e,r);if(this._private.global.mappingData=!0,"function"==typeof t)return n._private.global.subs.subscribePropertiesToComponents(t,s);if("object"==typeof t){var a={};return normalizeMap(t).forEach(function(t){var e=t.key,o=t.val,i=o.split("/")[0],r=o.split("/")[1],c=n._private.global.getContext()[i];a[e]=n._private.global.subs.subscribePropertiesToComponents(function(){var t;return t={},t[e]=c[r],t},s)[e]}),this._private.global.mappingData=!1,a=cleanse(a)}},t.prototype.emit=function(t,e){if(this._private.events[t])for(var o=0;o<this._private.events[t].length;o++)(0,this._private.events[t][o])(e)},t.prototype.on=function(t,e){Array.isArray(this._private.events[t])?this._private.events[t].push(e):this._private.events[t]=[e]},t.prototype.log=function(t){},t}();module.exports=Library;
//# sourceMappingURL=pulse.cjs.min.js.map
