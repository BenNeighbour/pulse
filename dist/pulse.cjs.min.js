"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var classCallCheck=_classCallCheck;function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var createClass=_createClass,Utils={Log:function(e){},assert:function(e){console.warn("[Pulse] - ".concat(e))},warn:function(e){console.error("[Pulse] - ".concat(e))}},Utils_1=Utils.Log,Utils_2=Utils.assert,Utils_3=Utils.warn;function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var _typeof_1=createCommonjsModule(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(r){return"function"==typeof Symbol&&"symbol"===t(Symbol.iterator)?e.exports=n=function(e){return t(e)}:e.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)},n(r)}e.exports=n}),runtime_1=createCommonjsModule(function(e){var t=function(e){var t,n=Object.prototype,r=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function l(e,t,n,r){var i=t&&t.prototype instanceof y?t:y,o=Object.create(i.prototype),a=new I(r||[]);return o._invoke=function(e,t,n){var r=u;return function(i,o){if(r===p)throw new Error("Generator is already running");if(r===d){if("throw"===i)throw o;return D()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var s=R(a,n);if(s){if(s===f)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===u)throw r=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=p;var l=c(e,t,n);if("normal"===l.type){if(r=n.done?d:h,l.arg===f)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(r=d,n.method="throw",n.arg=l.arg)}}}(e,n,a),o}function c(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var u="suspendedStart",h="suspendedYield",p="executing",d="completed",f={};function y(){}function _(){}function v(){}var g={};g[o]=function(){return this};var b=Object.getPrototypeOf,m=b&&b(b(T([])));m&&m!==n&&r.call(m,o)&&(g=m);var k=v.prototype=y.prototype=Object.create(g);function x(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function w(e){var t;this._invoke=function(n,i){function o(){return new Promise(function(t,o){!function t(n,i,o,a){var s=c(e[n],e,i);if("throw"!==s.type){var l=s.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?Promise.resolve(u.__await).then(function(e){t("next",e,o,a)},function(e){t("throw",e,o,a)}):Promise.resolve(u).then(function(e){l.value=e,o(l)},function(e){return t("throw",e,o,a)})}a(s.arg)}(n,i,t,o)})}return t=t?t.then(o,o):o()}}function R(e,n){var r=e.iterator[n.method];if(r===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,R(e,n),"throw"===n.method))return f;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var i=c(r,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,f;var o=i.arg;return o?o.done?(n[e.resultName]=o.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,f):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,f)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function j(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function T(e){if(e){var n=e[o];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return a.next=a}}return{next:D}}function D(){return{value:t,done:!0}}return _.prototype=k.constructor=v,v.constructor=_,v[s]=_.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===_||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(k),e},e.awrap=function(e){return{__await:e}},x(w.prototype),w.prototype[a]=function(){return this},e.AsyncIterator=w,e.async=function(t,n,r,i){var o=new w(l(t,n,r,i));return e.isGeneratorFunction(n)?o:o.next().then(function(e){return e.done?e.value:o.next()})},x(k),k[s]="Generator",k[o]=function(){return this},k.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=T,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(j),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var l=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),j(n),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;j(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:T(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),f}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}),regenerator=runtime_1;function asyncGeneratorStep(e,t,n,r,i,o,a){try{var s=e[o](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function a(e){asyncGeneratorStep(o,r,i,a,s,"next",e)}function s(e){asyncGeneratorStep(o,r,i,a,s,"throw",e)}a(void 0)})}}var asyncToGenerator=_asyncToGenerator,Collection=function(){function e(t,n){var r=t.name,i=t.global,o=n.data,a=void 0===o?{}:o,s=n.model,l=void 0===s?{}:s,c=n.actions,u=void 0===c?{}:c,h=n.filters,p=void 0===h?{}:h,d=n.indexes,f=void 0===d?[]:d,y=n.groups,_=void 0===y?[]:y,v=n.routes,g=void 0===v?{}:v,b=n.watch,m=void 0===b?{}:b,k=n.persist,x=void 0===k?[]:k,w=n.local,R=void 0===w?{}:w,O=n.onReady;classCallCheck(this,e),this._name=r,this._actionReference={collect:this.collect.bind(this),undo:this.undo.bind(this),move:this.move.bind(this),update:this.update.bind(this),put:this.put.bind(this),delete:this.delete.bind(this),deleteGroup:this.deleteGroup.bind(this),findById:this.findById.bind(this),getGroup:this.getGroup.bind(this),newGroup:this.newGroup.bind(this),forceUpdate:this.forceUpdate.bind(this),throttle:this.throttle.bind(this),remove:this.remove.bind(this),set:this.set.bind(this),increment:this.increment.bind(this),decrement:this.decrement.bind(this),purge:this.purge.bind(this),watch:this.watch.bind(this),replaceIndex:this.replaceIndex.bind(this),removeFromGroup:this.removeFromGroup.bind(this)};this._public=this.initProxy({groups:{},data:{},actions:{},filters:{},routes:{},indexes:{}}),this._global=i,this._regenQueue=this._global.regenQueue,this._onReady=O,this._model=l,this._filters=p,this._local=R,this._data={},this._indexes={},this._watchers={},this._storage={},this._filtersRelatedToData={},this._filtersRelatedToGroup={},this._relations={},this._groupRelations={},this._foreignGroupRelations={},this._subscribedToData={},this._watchers={},this._internalWatchers={},this._persist=[],this._throttles=[],this._modelTypes=[],this._mutableData=[],this._indexesToRegen=[],this._filtersToForceRegen=[],this._actionProcessingStack=[],this._collectionSize=0,this._primaryKey=null,this._executing=!1,this._collecting=!1,this._performingAction=!1,this._allowInternalChange=!1,this._global.internalDataRef[this._name]=this._data,this.initStorage(),this.initModel(l),this.initData(a),this.initGroups(f.concat(_)),this.initRoutes(g),this.initFilters(p),this.initActions(u),this.initWatchers(m),this.prepareNamespace(),this.initPersist(x),this.initOnReady(O)}return createClass(e,[{key:"initStorage",value:function(){var e=this;if(this._storageIsPromise=!!this._global.storage.async,"function"!=typeof this._global.storage.get)return this._global.storageInvalid=!0,Utils_2("Unable to access local storage, please assign a valid storage solution manually if you want data from Pulse to persist.");this._global.storage.get("_")instanceof Promise&&(this._storageIsPromise=!0);this._storage.get=function(t){return e._storageIsPromise?function(t){return new Promise((n=asyncToGenerator(regenerator.mark(function n(r){var i,o;return regenerator.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,e._global.storage.get(t);case 3:if("string"==typeof(i=n.sent)){n.next=6;break}return n.abrupt("return",r(i));case 6:return o=JSON.parse(i),n.abrupt("return",r(o));case 10:n.prev=10,n.t0=n.catch(0),r(null);case 13:case"end":return n.stop()}},n,null,[[0,10]])})),function(e){return n.apply(this,arguments)}));var n}(t):function(t){var n=e._global.storage.get(t);try{return JSON.parse(n)}catch(e){return n}}(t)},this._storage.set=function(t,n){e._global.storage.set(t,JSON.stringify(n))},this._storage.remove=function(t){return e._global.storage.remove(t)}}},{key:"initPersist",value:function(e){var t=this;this._global.storageInvalid||e.forEach(function(e){t._persist.push(e);var n="_".concat(t._name,"_").concat(e);if(!t._public.hasOwnProperty(e))return Utils_2('Unable to persist property "'.concat(e,'" in collection "').concat(t._name,'" as it does not exist.'));var r=t.searchNamespaceForProperty(e);if(!r)return Utils_2("Unable to persist. Property does not exist.");if(t._storageIsPromise)t._storage.get(n).then(function(n){null!=n&&(t._public[r][e]=n,t._public.hasOwnProperty(e)&&(t._public[e]=n))});else{var i=t._storage.get(n);if(null==i)return;i=t.initDeepReactivity(i,e),t._allowInternalChange=!0,t._public[r][e]=i,t._public.hasOwnProperty(e)&&(t._allowInternalChange=!0,t._public[e]=i)}})}},{key:"initData",value:function(e){var t=this;Object.keys(e).forEach(function(n){t._mutableData.push(n),e[n]=t.initDeepReactivity(e[n],n)}),this._public.data=this.initProxy(e)}},{key:"initGroups",value:function(e){this._public.groups=this.initProxy({});for(var t=0;t<e.length;t++){var n=e[t];if(this._public.groups[n]||this._indexes[n])return Utils_2("Duplicate declaration for index ".concat(n));this._indexes[n]=new Array,this._public.groups[n]=new Array,this._public.indexes[n]=new Array}this._public.indexes=this.initProxy(this._public.indexes,"indexes")}},{key:"initFilters",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];this._public.filters[r]=[],this._global.allFilters.push(r)}}},{key:"initRoutes",value:function(e){for(var t=this,n=Object.keys(e),r=function(r){var i=n[r],o=t;t._public.routes[i]=function(){return Object.assign(o._global.request).context=o.getContextObject(),e[i].apply(null,[o._global.request].concat(Array.prototype.slice.call(arguments)))}},i=0;i<n.length;i++)r(i)}},{key:"getContextObject",value:function(){return Object.assign({data:this._public.data,filters:this._public.filters,groups:this._public.groups,actions:this._public.actions,routes:this._public.routes},this._global.dataRef,this._actionReference,{local:this._local})}},{key:"initActions",value:function(e){for(var t=this,n=this,r=Object.keys(e),i=function(i){var o=r[i];t._public.actions[o]=function(){if(n._throttles.includes(o))return Promise.resolve();var t=arguments,r=Math.random(),i=null;n._actionProcessingStack.length>0&&(i=n._actionProcessingStack[n._actionProcessingStack.length-1].actionIdentifier);var a=n.getContextObject();a.undo=function(e){return n.undo(o,r,e)};var s={id:r,name:o,parentAction:i,runAction:function(){return e[o].apply(null,[a].concat(Array.prototype.slice.call(t)))}};return n.executeAction(s)}},o=0;o<r.length;o++)i(o)}},{key:"executeAction",value:function(e){this._performingAction=e.name,this._actionProcessingStack.push(e);var t=e.runAction();return this._performingAction=!1,this._actionProcessingStack.pop(),this._actionProcessingStack.length,t}},{key:"initWatchers",value:function(e){for(var t=this,n=this,r=Object.keys(e),i=function(i){var o=r[i];t._watchers[o]=function(){return e[o](n.getContextObject())}},o=0;o<r.length;o++)i(o)}},{key:"initOnReady",value:function(e){var t=this;this._onReady=function(){e&&e(t.getContextObject())}}},{key:"initProxy",value:function(){var e,t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(r)e=Object.create({rootProperty:r});else{var o=Object.assign({},this._actionReference,r);e=Object.create(o)}for(var a=Object.keys(n),s=0;s<a.length;s++){var l=a[s];e[l]=n[l]}return i?new Proxy(e,{set:function(e,n,r){if(Object.getPrototypeOf(e).rootProperty){var i=Object.getPrototypeOf(e).rootProperty;return t._mutableData.includes(i)&&(e[n]=r,t.updateSubscribers(i,t._public[i]),t.findAndUpdateDependents(i)),!0}return e[n]=r,!0},get:function(e,t,n){return e[t]}}):"indexes"===r?new Proxy(e,{set:function(e,n,r){return e[n]=r,t._allowInternalChange||t.replaceIndex(n,r,!0),!0},get:function(e,t,n){return e[t]}}):new Proxy(e,{set:function(e,n,i){if(!t._global.initComplete||t._allowInternalChange)return e[n]=i,t._allowInternalChange=!1,!0;if(t._mutableData.includes(n)){var o=e[n];e[n]=i,Utils_1('User mutated data "'.concat(n,'" in collection "').concat(t._name,'"')),t.recordHistory("mutation",{key:n,rootProperty:r,previousValue:o,newValue:i});var a=t.initDeepReactivity(e[n],n);return e[n]=a,t._allowInternalChange=!0,t._public.data[n]=i,t._allowInternalChange=!1,t.updateSubscribers(n,i),t.findAndUpdateDependents(n),!0}return Object.keys(t._public).includes(n)?Utils_2('Cannot set data property "'.concat(n,'" in collection "').concat(t._name,'". Filters and groups are not mutable.')):Utils_2('Cannot set data property "'.concat(n,'" in collection "').concat(t._name,'" as "').concat(n,'" does not exist.')),!0},get:function(e,n,r){return Object.getPrototypeOf(e).rootProperty?e[n]:(t._global.record&&!["filters","groups","indexes","data","actions"].includes(n)&&0===t._global.dependenciesFound.filter(function(e){return e.property===n&&e.collection===t._name}).length&&t._global.dependenciesFound.push({property:n,collection:t._name}),e[n])}})}},{key:"replaceIndex",value:function(e,t,n){var r=this._indexes[e];this._indexes[e]=t,this.buildGroupFromIndex(e,n),this.regenerateFilters(),this._public.groups[e]&&this.findAndUpdateDependents(e),this.recordHistory("indexMutation",{index:e,previousIndex:r,newIndex:t})}},{key:"isWatchableObject",value:function(e){var t=_typeof_1(e);return null!=e&&"object"==t&&!this.isHTMLElement(e)&&!Array.isArray(e)}},{key:"isHTMLElement",value:function(e){try{return e instanceof HTMLElement}catch(t){return"object"===_typeof_1(e)&&1===e.nodeType&&"object"===_typeof_1(e.style)&&"object"===_typeof_1(e.ownerDocument)}}},{key:"initDeepReactivity",value:function(e,t){var n=this,r=[];if(!this.isWatchableObject(e))return e;for(var i=this.initProxy(e,t,!0),o=Object.keys(e),a=0;a<o.length;a++){var s=o[a];this.isWatchableObject(e[s])&&r.push({target:e,key:s})}return function e(){var i=r;r=[];for(var o=0;o<i.length;o++){var a=i[o],s=a.key,l=a.target;n._allowInternalChange=!0,l[s]=n.initProxy(l[s],t,!0);for(var c=Object.keys(l[s]),u=0;u<c.length;u++){var h=c[u];n.isWatchableObject(l[s][h])&&r.push({target:l[s],key:h})}}r.length>0?e():n._allowInternalChange=!1}(),i}},{key:"initModel",value:function(e){var t=this;Object.keys(e).forEach(function(n){Object.keys(e[n]).forEach(function(r){if("primaryKey"===r)t._primaryKey=n;else if("type"===r)["string","boolean","integer","number","array","object"].includes(e[n].type)?t._modelTypes.includes(n)||t._modelTypes.push(n):Utils_2('Error in model in collection "'.concat(t._name,'", type "').concat(e[n].type,'" is not valid.'));else if("parent"===r||"hasOne"===r){var i=e[n].parent||e[n].hasOne;t.createDataRelation(n,i,e[n].assignTo)}else if("has"===r||"hasMany"===r){var o=e[n].has||e[n].hasMany;t.createGroupRelation(n,o,e[n].assignTo)}})})}},{key:"createDataRelation",value:function(e,t,n){if(!this._global.collectionNamespace.includes(t))return Utils_2('"'.concat(collection,'" is not a valid collection.'));this._relations[e]={},this._relations[e].fromCollectionName=t,n&&(this._relations[e].assignTo=n)}},{key:"createGroupRelation",value:function(e,t,n){if(!this._global.collectionNamespace.includes(t))return Utils_2('"'.concat(collection,'" is not a valid collection.'));this._groupRelations[e]={},this._groupRelations[e].fromCollectionName=t,n&&(this._groupRelations[e].assignTo=n)}},{key:"searchNamespaceForProperty",value:function(e){for(var t=["filters","data","groups"],n=0;n<t.length;n++){var r=t[n];if(Object.keys(this._public[r]).includes(e))return r}return!1}},{key:"validateNamespace",value:function(e,t){var n=this;return Object.keys(e).forEach(function(r){if(e.hasOwnProperty(t))return Utils_3('Duplicate property "'.concat(t,'" on collection "').concat(n._name,'"')),!1}),!0}},{key:"prepareNamespace",value:function(){var e=this;Object.keys(this._public).forEach(function(t){["data","actions","groups","filters"].includes(t)&&Object.keys(e._public[t]).forEach(function(n){e.validateNamespace(e._public,n)&&(e._public[n]=e._public[t][n])})})}},{key:"checkNamespace",value:function(e){return!!this._public.data.hasOwnProperty(e)||(Utils_2('Namespace error "'.concat(e,'" is already taken for collection "').concat(this._name,'".')),!1)}},{key:"persistData",value:function(e,t){if(this._persist.includes(e)){var n="_".concat(this._name,"_").concat(e);this._storage.set(n,t)}}},{key:"findPrimaryKey",value:function(e){for(var t=["id","_id"],n=0;n<t.length;n++){var r=t[n];e.hasOwnProperty(r)&&(this._primaryKey=r)}this._primaryKey||this.dataRejectionHandler(e,"No primary key supplied.")}},{key:"createRelationForIndex",value:function(e){for(var t=Object.keys(this._relations),n=0;n<t.length;n++){var r=t[n];this._relations[r][e]=[]}}},{key:"analyseFilters",value:function(){if(this._filters)for(var e=Object.keys(this._filters),t=0;t<e.length;t++){var n=e[t];this.executeAndAnalyseFilter(n)}}},{key:"executeAndAnalyseFilter",value:function(e){this._global.record=!0,this.executeFilter(e);var t=this._global.dependenciesFound;this._global.dependenciesFound=[];for(var n=0;n<t.length;n++){var r=t[n];if(this.checkForMissingDependency(r,e))return}this.populateDependencies(t,e),this._global.generatedFilters.push(this._name+e),Utils_1("Generated ".concat(e," for collection ").concat(this._name))}},{key:"executeFilter",value:function(e){this._executing=e;var t=Object.assign({data:this._public.data,filters:this._public.filters,groups:this._public.groups,actions:this._public.actions},this._global.dataRef,this._actionReference,{local:this._local}),n=this._filters[e](t);this._executing=!1,this._global.record=!1,null==n&&(n=!1),this.deliverUpdate("filters",n,e)}},{key:"emitToRoot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._global.eventBus.message={type:e,data:t}}},{key:"buildGroupFromIndex",value:function(e,t){for(var n=[],r=0;r<this._indexes[e].length;r++){var i=this._indexes[e][r],o=this._data[i];if(o){var a=Object.keys(this._relations);if(a.length>0)for(var s=0;s<a.length;s++){var l=a[s],c=this._relations[l],u=!!c.hasOwnProperty("assignTo")&&c.assignTo;if(o.hasOwnProperty(l)){var h=this._global.internalDataRef[c.fromCollectionName][o[l]];h&&(u?o[u]=h:o[c.fromCollectionName]=h)}}var p=Object.keys(this._groupRelations);if(p.length>0)for(var d=0;d<p.length;d++){var f=p[d],y=this._groupRelations[f],_=!!y.hasOwnProperty("assignTo")&&y.assignTo;if(o.hasOwnProperty(f)){var v=this._global.dataRef[y.fromCollectionName][o[f]];v&&(_?o[_]=v:o[y.fromCollectionName]=v),this.emitToRoot("createForeignGroupRelation",{foreignCollection:y.fromCollectionName,foreignData:o[f],dependentCollection:this._name,dependentGroup:e})}}n.push(o)}}return(this._public.hasOwnProperty(e)||this._public.groups.hasOwnProperty(e))&&this.deliverUpdate("groups",n,e),t||(this._allowInternalChange=!0,this._public.indexes[e]=this._indexes[e],this._allowInternalChange=!1),this.findFiltersToRegenFromRelatedGroup(e),n}},{key:"internalDataModified",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];this.findGroupsToRegen(n),this.findFiltersToRegenFromRelatedData(n)}else this.findGroupsToRegen(e),this.findFiltersToRegenFromRelatedData(e);this.regenerateGroupsAndFilters()}},{key:"deliverUpdate",value:function(e,t,n){this._allowInternalChange=!0,this._public[e][n]=t,this._allowInternalChange=!1,this._public.hasOwnProperty(n)&&(this._allowInternalChange=!0,this._public[n]=t,this._allowInternalChange=!1),this.updateSubscribers(n,t);for(var r=Object.keys(this._foreignGroupRelations),i=0;i<r.length;i++){var o=r[i];n===o&&this.emitToRoot("rebuildGroupsWithRelations",this._foreignGroupRelations[o])}}},{key:"updateSubscribers",value:function(e,t){var n=this;this._watchers.hasOwnProperty(e)&&setTimeout(function(){return n._watchers[e](n._global.dataRef)}),this._internalWatchers.hasOwnProperty(e)&&setTimeout(function(){for(var t=0;t<n._internalWatchers[e].length;t++){(0,n._internalWatchers[e][t])()}}),this.persistData(e,t);var r=this._global.config.framework;if(this._subscribedToData[e])for(var i=0;i<this._subscribedToData[e].length;i++){var o=this._subscribedToData[e][i],a=this._global.componentStore[o.componentUUID];if(!a)return;if(!a.instance)return Utils_2("No component instance..");if("vue"===r||a.instance.hasOwnProperty("$vnode"))a.ready&&a.instance.$set(a.instance,o.key,t);else if("react"===r){var s={};s[o.key]=t,a.instance.state.hasOwnProperty("_mounted")?a.instance.state._mounted&&a.instance.setState(s):a.ready&&a.instance.setState(s)}}}},{key:"recordHistory",value:function(e,t){var n=null,r=null,i=null;if(0!==this._actionProcessingStack.length||"mutation"!==e){if(this._actionProcessingStack.length>0){var o=this._actionProcessingStack[this._actionProcessingStack.length-1];r=o.id,n=o.name,o.parentAction&&(i=o.parentAction.id)}var a={type:e,timestamp:Date.now(),collection:this._name,fromAction:n,fromActionIdentifier:r,fromActionParentIdentifier:i,data:t};this._global.history.push(a)}}},{key:"populateDependencies",value:function(e,t){for(var n=this._global.dependencyGraph,r=0;r<e.length;r++){var i=e[r],o="".concat(i.collection,"/").concat(i.property),a=n[this._name][t];a.dependencies.includes(o)||a.dependencies.push(o);var s="".concat(this._name,"/").concat(t),l=n[i.collection][i.property];l&&l.dependents&&!l.dependents.includes(s)&&l.dependents.push(s)}}},{key:"checkForMissingDependency",value:function(e,t){var n=this._global;return!(!n.allFilters.includes(e.property)||n.generatedFilters.includes(e.collection+e.property))&&(Utils_1('Dependent "'.concat(e.property,'" has not been analysed yet, saving this filter to regen queue.')),this._regenQueue.push({type:"filter",property:t,collection:this._name}),!0)}},{key:"findAllDependents",value:function(e){var t=this,n=this._global.dependencyGraph;if(!n[this._name][e])return[];for(var r=n[this._name][e].dependents,i=[],o=0,a=[],s=0;s<r.length;s++){var l=r[s];a.push(l),i.push(l)}return function e(){o++;var r=a;a=[];for(var s=0;s<r.length;s++)for(var l=r[s],c=t.parseKey(l),u=n[c.collection][c.property].dependents,h=0;h<u.length;h++){var p=u[h];a.push(p),i.push(p)}if(o>1e3)return Utils_2("Maximum stack exceeded for dependent search.");0!==a.length&&e()}(),i}},{key:"findAndUpdateDependents",value:function(e){var t=[];if(Array.isArray(e))for(var n=0;n<e.length;n++)for(var r=this.findAllDependents(e[n]),i=0;i<r.length;i++){var o=r[i];t.includes(o)||t.push(o)}else t=this.findAllDependents(e);Utils_1("Found dependents: ".concat(JSON.stringify(t))),this.pushDependentsToRegenQueue(t)}},{key:"pushDependentsToRegenQueue",value:function(e){for(var t=this,n=function(n){var r=t.parseKey(e[n]),i=r.property,o=r.collection;t._regenQueue.find(function(e){return e.property===i&&e.collection===o})||t._regenQueue.push({type:"filter",property:i,collection:o})},r=0;r<e.length;r++)n(r);this.emitToRoot("processRegenQueue")}},{key:"forceUpdate",value:function(e){this._filters.hasOwnProperty(e)?(this._regenQueue.push({type:"filter",property:e,collection:this._name}),this.emitToRoot("processRegenQueue")):this._mutableData.includes(e)&&(this.initDeepReactivity(this._public[e],e),this.updateSubscribers(e,this._public[e]),this.findAndUpdateDependents(e))}},{key:"collect",value:function(e,t){if(!e)return Utils_2("Collect error on collection ".concat(this._name,": Data undefined"));Array.isArray(e)||(e=[e]),this._collecting=!0;var n=[],r=[];if(t)if(Array.isArray(t))for(var i=0;i<t.length;i++){var o=t[i];this.createRelationForIndex(o),this._indexesToRegen.push(o),this._indexes[o]||(this._indexes[o]=[]),n.push({indexName:o,previousValue:this._indexes[o]})}else this.createRelationForIndex(t),this._indexesToRegen.push(t),this._indexes[t]||(this._indexes[t]=[]),r.push(t);if(Array.isArray(e))for(var a=0;a<e.length;a++){var s=e[a];this.processDataItem(s,t,e)}else this.processDataItem(e,t);this.recordHistory("collect",{dataCollected:e,indexesCreated:r,indexesModified:n}),this._collecting=!1,Utils_1("Collected ".concat(e.length," items in ").concat(this._name,". With index: ").concat(t)),this.regenerateGroupsAndFilters()}},{key:"processDataItem",value:function(e,t){var n=!0;if(this._primaryKey||this.findPrimaryKey(e),null===e)return this.dataRejectionHandler(e,"Data cannot be null");if("object"!==_typeof_1(e))return this.dataRejectionHandler(e,"Collected data must be an object, but we recieved ".concat(_typeof_1(e)));for(var r=0;r<this._modelTypes.length;r++){var i=this._modelTypes[r],o=this._model[i].type;e[i]=this.validateDataPropertyAgainstType(e[i],o)}if(!e.hasOwnProperty(this._primaryKey))return this.dataRejectionHandler(e,"Primary key mismatch. ");var a=e[this._primaryKey],s=this._data[a];if(s&&(Object.keys(s).forEach(function(t){e.hasOwnProperty(t)||(e[t]=s[t])}),n=!1),t){Array.isArray(t)||(t=[t]);for(var l=0;l<t.length;l++){var c=t[l];this._indexes[c].includes(a)||this._indexes[c].push(a)}}for(var u=Object.keys(this._relations),h=0;h<u.length;h++){var p=u[h],d=this._relations[p];Array.isArray(d[t])&&d[t].push(e[p])}Object.keys(this._data).includes(a)&&this.findGroupsToRegen(a),this.findFiltersToRegenFromRelatedData(a),this.findFiltersToRegenFromRelatedGroup(t),this._data[a]=e,n&&this._collectionSize++}},{key:"validateDataPropertyAgainstType",value:function(e,t){switch(t){case"array":return Array.isArray(e)?e:[];case"string":return"string"==typeof e?e:"";case"boolean":return"boolean"==typeof e&&e;case"integer":case"number":return"number"==typeof e?e:0;case"object":return"object"===_typeof_1(e)?e:{};default:return Utils_2('Data validation failed. Type: "'.concat(t,'" not supported')),null}}},{key:"findGroupsToRegen",value:function(e){for(var t=Object.keys(this._indexes),n=0;n<t.length;n++){var r=t[n];this._indexes[r].includes(e)&&!this._indexesToRegen.includes(r)&&this._indexesToRegen.push(r)}}},{key:"findFiltersToRegenFromRelatedData",value:function(e){if(this._filtersRelatedToData[e])for(var t=0;t<this._filtersRelatedToData[e].length;t++){var n=this._filtersRelatedToData[e][t];this._filtersToForceRegen.includes(n)||this._filtersToForceRegen.push(n)}}},{key:"findFiltersToRegenFromRelatedGroup",value:function(e){if(this._filtersRelatedToGroup[e])for(var t=0;t<this._filtersRelatedToGroup[e].length;t++){var n=this._filtersRelatedToGroup[e][t];this._filtersToForceRegen.includes(n)||this._filtersToForceRegen.push(n)}}},{key:"regenerateGroupsAndFilters",value:function(){this.regenerateGroups(),this.regenerateFilters()}},{key:"regenerateGroups",value:function(){for(var e=0;e<this._indexesToRegen.length;e++){var t=this._indexesToRegen[e];Utils_1('Rebuilding group "'.concat(t,'" in collection "').concat(this._name,'"')),this.buildGroupFromIndex(t),this._global.dataRef[this._name][t]&&this.findAndUpdateDependents(t)}this._indexesToRegen=[]}},{key:"regenerateFilters",value:function(){for(var e=0;e<this._filtersToForceRegen.length;e++){var t=this._filtersToForceRegen[e];this.pushDependentsToRegenQueue(["".concat(this._name,"/").concat(t)]),this.findAndUpdateDependents(t)}this._filtersToForceRegen=[]}},{key:"undo",value:function(e,t,n){var r=this._global.history.filter(function(e){return e.fromActionIdentifier===t});if(this.emitToRoot("undo",r),n)throw n}},{key:"move",value:function(e,t,n,r){var i=this;if(!this._indexes[t])return Utils_2('Index "'.concat(t,'" not found'));if(!1!==n&&null!=n&&!this._indexes[n])return Utils_2('Index "'.concat(n,'" not found'));Array.isArray(e)||(e=[e]);for(var o={ids:e,fromIndex:t,toIndex:n,previousFromIndexValue:this._indexes[t],previousToIndexValue:this._indexes[n]},a=function(o){var a=e[o];if(!i._data[a])return{v:Utils_2('Data for id "'.concat(a,'" not found in collection ').concat(i._name))};i._indexes[t]=i._indexes[t].filter(function(e){return e!==a}),n&&("unshift"===r?i._indexes[n].unshift(a):i._indexes[n].push(a))},s=0;s<e.length;s++){var l=a(s);if("object"===_typeof_1(l))return l.v}this.buildGroupFromIndex(t),n&&this.buildGroupFromIndex(n),this.recordHistory("move",o),n?this.findAndUpdateDependents([t,n]):this.findAndUpdateDependents([t])}},{key:"remove",value:function(e,t){var n=this;if(void 0!==t&&!this._indexes[t])return Utils_2('Group "'.concat(t,'" not found.'));if(!t)return this.delete(e);if(Array.isArray(e)||(e=[e]),"object"==_typeof_1(e[0])&&e[0].hasOwnProperty(this._primaryKey))e=e.map(function(e){return e[n._primaryKey]});else if("number"!=typeof e[0]&&"string"!=typeof e[0])return Utils_2("Unable to remove data.");var r=this._indexes[t].concat([]);this._indexes[t]=this._indexes[t].filter(function(t){return!e.includes(t)}),this.buildGroupFromIndex(t),this.recordHistory("remove",{group:t,previousValue:r}),this.findAndUpdateDependents(t)}},{key:"put",value:function(e,t,n){var r=this;if(!this._indexes[t])return Utils_2('Index "'.concat(t,'" not found'));Array.isArray(e)||(e=[e]);for(var i=this._indexes[t].concat([]),o=function(i){var o=e[i],a=[];a=r._indexes[t].includes(o)?r._indexes[t].filter(function(e){return e!=o}):r._indexes[t],"unshift"===n?a.unshift(o):a.push(o),r._indexes[t]=a},a=0;a<e.length;a++)o(a);this.buildGroupFromIndex(t),this.recordHistory("put",{group:t,ids:e,previousDestIndex:i}),this.findAndUpdateDependents(t)}},{key:"update",value:function(e,t){if(this._data[e]){for(var n=this._data[e],r={dataId:e,previousValues:{},newValues:t},i=Object.keys(t),o=0;o<i.length;o++){var a=i[o];r.previousValues[a]=n[a],n[a]=t[a]}this.recordHistory("update",r),this.internalDataModified(e)}else Utils_2('Data for id "'.concat(e,'" not found in collection ').concat(this._name))}},{key:"createRelationForFilterToData",value:function(e,t){Array.isArray(this._filtersRelatedToData[t])&&!this._filtersRelatedToData[t].includes(e)?this._filtersRelatedToData[t].push(e):this._filtersRelatedToData[t]=[e]}},{key:"createRelationForFilterToGroup",value:function(e,t){Array.isArray(this._filtersRelatedToGroup[t])&&!this._filtersRelatedToGroup[t].includes(e)?this._filtersRelatedToGroup[t].push(e):this._filtersRelatedToGroup[t]=[e]}},{key:"findById",value:function(e){if(this._executing&&this.createRelationForFilterToData(this._executing,e),this._data[e])return this._data[e];Utils_1('findByID: Item "'.concat(e,'" not found in collection "').concat(this._name,'"'))}},{key:"getGroup",value:function(e){return this._executing&&this.createRelationForFilterToGroup(this._executing,e),this._indexes[e]?this.buildGroupFromIndex(e):[]}},{key:"newGroup",value:function(e,t){Object.keys(this._indexes).includes(e)||(this._indexes[e]=t,this.recordHistory("newGroup",{createdGroup:e,data:t}))}},{key:"modifyGroup",value:function(e){}},{key:"delete",value:function(e){var t=this;if(this._indexes[e])return Utils_2("Delete function only supports primary keys for data, if you're trying to delete a group, please use deleteGroup()");var n=function(e){var n=Object.assign({},t._data[e]);delete t._data[e],t.recordHistory("delete",{primaryKey:e,deleted:n})};if(Array.isArray(e))for(var r=0;r<e.length;r++){n(e[r])}else n(e);this.internalDataModified(e)}},{key:"deleteGroup",value:function(e){if(!this._indexes[e])return Utils_2('Group "'.concat(e,'" not found.'));for(var t=0;t<this._indexes[e].length;t++){var n=this._indexes[e][t];this._data[n]&&delete this._data[n]}var r=this._indexes[e];this._indexes[e]=[],this.buildGroupFromIndex(e),this.recordHistory("deleteGroup",{group:e,previousValue:r}),this.findAndUpdateDependents(e)}},{key:"removeFromGroup",value:function(e,t){var n=this;Array.isArray(e)||(e=[e]);for(var r=function(r){if(!n._indexes[t])return Utils_2('Index for group "'.concat(t,'" not found in collection "').concat(n._name,'"')),"continue";var i=e[r],o=n._indexes[t].filter(function(e){return e!=i});n.replaceIndex(t,o)},i=0;i<e.length;i++)r(i)}},{key:"purge",value:function(){this._data={};for(var e=Object.keys(this._indexes),t=0;t<e.length;t++){var n=e[t];this._indexes[n]=[],this._indexesToRegen.push(n)}this.regenerateGroupsAndFilters()}},{key:"clean",value:function(){}},{key:"increment",value:function(e,t,n){this.validateNumberForDataProperty(e,t,n)&&(this._data[e][t]+=n,this.recordHistory("increment",{primaryKey:e,property:t,amount:n}),this.internalDataModified(e))}},{key:"decrement",value:function(e,t,n){this.validateNumberForDataProperty(e,t,n)&&(this._data[e][t]-=n,this.recordHistory("decrement",{primaryKey:e,property:t,amount:n}),this.internalDataModified(e))}},{key:"throttle",value:function(e){var t=this,n=this._performingAction;this._throttles.push(n),setTimeout(function(){t._throttles=t._throttles.filter(function(e){return e!==n})},e)}},{key:"set",value:function(e,t){}},{key:"watch",value:function(e,t){if(!this._public[e])return Utils_2('Error in watch function, property "'.concat(e,'" does not exist'));this._internalWatchers[e]||(this._internalWatchers[e]=[]),this._internalWatchers[e].push(t)}},{key:"validateNumberForDataProperty",value:function(e,t,n){return!(!this._data[e]||!this._data[e][t]||"number"!=typeof n||"number"!=typeof this._data[e][t])||(Utils_2("Property ".concat(t," for ").concat(e," is not a number")),!1)}},{key:"dataRejectionHandler",value:function(e,t){var n="[Data Rejection] - ".concat(t,' - Data was not collected, but instead saved to the errors object("_errors") on root Pulse instance.');this._global.errors.push({data:e,timestamp:new Date,error:n}),Utils_2(n)}},{key:"parseKey",value:function(e){return{collection:e.split("/")[0],property:e.split("/")[1]}}}]),e}();function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var assertThisInitialized=_assertThisInitialized;function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof_1(t)&&"function"!=typeof t?assertThisInitialized(e):t}var possibleConstructorReturn=_possibleConstructorReturn,getPrototypeOf=createCommonjsModule(function(e){function t(n){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(n)}e.exports=t}),setPrototypeOf=createCommonjsModule(function(e){function t(n,r){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(n,r)}e.exports=t});function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&setPrototypeOf(e,t)}var inherits=_inherits,Base=function(e){function t(e,n){var r=n.data,i=void 0===r?{}:r,o=n.actions,a=void 0===o?{}:o,s=n.routes,l=void 0===s?{}:s,c=n.filters,u=void 0===c?{}:c,h=n.groups,p=void 0===h?[]:h,d=n.watch,f=void 0===d?{}:d,y=n.persist,_=void 0===y?[]:y;return classCallCheck(this,t),i.isAuthenticated=!1,i.appReady=!1,_.push("isAuthenticated"),possibleConstructorReturn(this,getPrototypeOf(t).call(this,{name:"base",global:e},{data:i,actions:a,groups:p,persist:_,routes:l,filters:u,watch:f}))}return inherits(t,Collection),t}(),Request=function(e){function t(e,n){var r,i=n.baseURL,o=n.requestIntercept,a=n.responseIntercept,s=n.mode,l=n.credentials,c=n.headers,u=(n.saveHistory,n.timeout);classCallCheck(this,t);var h={baseURL:i,mode:"cors",credentials:"same-origin",headers:{Accept:"application/json"}};return i||(h.baseURL=null),c&&Object.keys(c).forEach(function(e){h.headers[e]=c[e]}),l&&(h.credentials=l),s&&(h.mode=s),(r=possibleConstructorReturn(this,getPrototypeOf(t).call(this,{name:"request",global:e},{groups:[],data:h,persist:["baseURL"]})))._requestIntercept=o,r._responseIntercept=a,r._timeout=u,r._saveHistory=void 0===r._saveHistory,r._global.request={get:r.get.bind(assertThisInitialized(r)),post:r.post.bind(assertThisInitialized(r)),put:r.put.bind(assertThisInitialized(r)),patch:r.patch.bind(assertThisInitialized(r)),delete:r.delete.bind(assertThisInitialized(r)),queryify:r.queryify.bind(assertThisInitialized(r))},r}return inherits(t,Collection),createClass(t,[{key:"send",value:function(){var e=asyncToGenerator(regenerator.mark(function e(t,n,r,i){var o,a,s,l,c,u,h,p,d,f=this;return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=Object.assign({},this._public.headers),i&&Object.keys(i).forEach(function(e){o[e]=i[e]}),"get"!=n&&void 0===o["Content-Type"]&&(o["Content-Type"]="application/json"),a=t.startsWith("http")?t:"".concat(this._global.dataRef.request.baseURL,"/").concat(t),r=JSON.stringify(r),this._options={},this._options.credentials=this._global.dataRef.request.credentials,this._options.mode=this._global.dataRef.request.mode,s=Object.assign({headers:o,method:n.toUpperCase(),body:"get"==n?null:r},this._options),this._requestIntercept&&this._requestIntercept(this.getContextObject(),s),!this._timeout){e.next=16;break}return e.next=13,Promise.race([fetch(a,s),new Promise(function(e,t){return setTimeout(function(){return t("timeout")},f._timeout)})]);case 13:l=e.sent,e.next=19;break;case 16:return e.next=18,fetch(a,s);case 18:l=e.sent;case 19:if(!(c=l.headers.get("content-type"))||-1===c.indexOf("application/json")){e.next=26;break}return e.next=23,l.json();case 23:r=e.sent,e.next=29;break;case 26:return e.next=28,l.text();case 28:r=e.sent;case 29:if(this._saveHistory||this.collect({id:Date.now(),status:l.status,timestamp:new Date,response:r}),Array.isArray(r)||"object"!==_typeof_1(r))u=r;else for(u=Object.create({response:function(){return l}}),h=Object.keys(r),p=0;p<h.length;p++)d=h[p],u[d]=r[d];if(this._responseIntercept&&(l.data=r,this._responseIntercept(this.getContextObject(),l)),!l.ok&&!l.redirected){e.next=34;break}return e.abrupt("return",u);case 34:throw u;case 35:case"end":return e.stop()}},e,this)}));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"get",value:function(e,t){return this.send(e,"get",{},t)}},{key:"post",value:function(e,t,n){return this.send(e,"post",t,n)}},{key:"patch",value:function(e,t,n){return this.send(e,"patch",t,n)}},{key:"delete",value:function(e,t,n){return this.send(e,"delete",t,n)}},{key:"put",value:function(e,t,n){return this.send(e,"put",t,n)}},{key:"queryify",value:function(e){var t=function(e){switch(_typeof_1(e)){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};return"object"!=_typeof_1(e)?Utils_2("queryify error, object must be defined"):Object.keys(e).map(function(n){var r=encodeURIComponent(t(n))+"=";return Array.isArray(e[n])?e[n].map(function(e){return r+encodeURIComponent(t(e))}).join("&"):r+encodeURIComponent(t(e[n]))}).join("&")}}]),t}();function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var defineProperty=_defineProperty;function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){defineProperty(e,t,n[t])})}return e}var objectSpread=_objectSpread;function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function pulseHOC(e,t,n,r){return function(i){function o(t){var n;return classCallCheck(this,o),(n=possibleConstructorReturn(this,getPrototypeOf(o).call(this,t))).state=objectSpread({},e.mapData(r,assertThisInitialized(n),{waitForMount:!0})),n}return inherits(o,i),createClass(o,[{key:"componentDidMount",value:function(){e._global.config.waitForMount&&e.mount(this)}},{key:"componentWillUnmount",value:function(){e._global.config.autoUnmount&&e.unmount(this)}},{key:"render",value:function(){return t.createElement(n,_extends({pulse:this.state},this.props))}}]),o}(t.Component)}var Pulse=function(){function e(t){var n=t.storage,r=t.collections,i=void 0===r?{}:r,o=t.utils,a=void 0===o?{}:o,s=t.services,l=void 0===s?{}:s,c=t.staticData,u=void 0===c?{}:c,h=t.request,p=void 0===h?{}:h,d=t.data,f=void 0===d?{}:d,y=t.actions,_=void 0===y?{}:y,v=t.filters,g=void 0===v?{}:v,b=t.watch,m=void 0===b?{}:b,k=t.routes,x=void 0===k?{}:k,w=t.local,R=void 0===w?{}:w,O=t.groups,j=void 0===O?[]:O,I=t.indexes,T=void 0===I?[]:I,D=t.persist,P=void 0===D?[]:D,F=t.jobs,U=void 0===F?{}:F,C=t.config,A=void 0===C?{}:C;classCallCheck(this,e),A.ssr||(window._pulse=this),A=this.prepareConfig(A),this._collections={},this._subscribers=[],this._mappedProperties={},this._eventBus=this.activateEventBus(),this._global={componentStore:{},regenQueue:[],errors:[],history:[],allFilters:[],collectionNamespace:[],updateSubscribers:this.updateSubscribers,eventBus:this._eventBus,dependenciesFound:[],dependencyGraph:{},generatedFilters:[],record:!1,initComplete:!1,request:{},dataRef:{},internalDataRef:{},storage:{},relations:{},config:A},this.initStorage(n),this.initCollections(i,{data:f,indexes:T,actions:_,filters:g,routes:x,groups:j,watch:m,persist:P,local:R},p),this.utils=a,this.services=l,this.staticData=u,this.buildGlobalDataRefrenceTree(),this.prepareDependencyGraph(),this.executeAllFilters(),this.processRegenQueue(),this._global.initComplete=!0,this.runOnReadyHandlers(),this.initJobs(U)}return createClass(e,[{key:"wrapped",value:function(e,t){var n=this._global.config;return!("react"!==n.framework||!n.frameworkConstructor)&&pulseHOC(this,n.frameworkConstructor,e,t)}},{key:"prepareConfig",value:function(e){return e.framework&&e.framework.hasOwnProperty("__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED")&&(e.frameworkConstructor=e.framework,e.framework="react"),"react"===e.framework&&(0!=e.waitForMount&&(e.waitForMount=!0),0!=e.autoUnmount&&(e.autoUnmount=!0)),Object.assign({framework:null,waitForMount:!1,autoUnmount:!1},e)}},{key:"unmount",value:function(e){var t=e.__pulseUniqueIdentifier;if(!t)return Utils_2("Failed to unmount component. No UUID found");var n=this._global.componentStore[e.__pulseUniqueIdentifier];if(!n.mappedData)return Utils_2("Failed to unmount");for(var r=Object.keys(n.mappedData),i=0;i<r.length;i++){var o=r[i],a=n.mappedData[o],s=a.split("/")[0],l=a.split("/")[1],c=this._collections[s];c&&(c._subscribedToData[l]=c._subscribedToData[l].filter(function(e){return e.componentUUID!==t}))}delete this._global.componentStore[e.__pulseUniqueIdentifier]}},{key:"mount",value:function(e){var t=this._global.componentStore[e.__pulseUniqueIdentifier];t&&(t.instance=e,t.ready=!0)}},{key:"install",value:function(e){var t=this,n=t._global.config.waitForMount;e.mixin({beforeCreate:function(){var e=this;Object.keys(t._global.dataRef).forEach(function(n){e["$"+n]=t._global.dataRef[n]}),this.$utils=t.utils,this.$services=t.services,this.$staticData=t.staticData,this.mapData=function(r){return t.mapData(r,e,{waitForMount:n.waitForMount})}},mounted:function(){this.__pulseUniqueIdentifier&&n.waitForMount&&t.mount(this)},beforeDestroy:function(){this.__pulseUniqueIdentifier&&n.autoUnmount&&t.unmount(this)}})}},{key:"mapData",value:function(e,t,n){t=t||this;var r={},i=null;if(!window)return Utils_2("Failed to map data, unable to access initialized instance of Pulse");i=window._pulse;var o=t.__pulseUniqueIdentifier;if(o)i.mount(t);else{var a={instance:t,uuid:o=Math.random().toString().split(".")[1]+Date.now(),ready:!n||!n.waitForMount,mappedData:e,config:n};t.__pulseUniqueIdentifier=o,i._global.componentStore[o]=a}return e&&i.normalizeMap(e).forEach(function(e){var t=e.key,n=e.val,a=n.split("/")[0],s=n.split("/")[1];if(i.hasOwnProperty(a)){var l=i._collections[a]._subscribedToData,c={componentUUID:o,key:t};l.hasOwnProperty(s)?l[s].push(c):l[s]=[c],r[t]=i[a][s]}}),r}},{key:"mapCollections",value:function(){var e=this,t={};return Object.keys(this._global.dataRef).forEach(function(n){t[n]=e._global.dataRef[n]}),t}},{key:"normalizeMap",value:function(e){return Array.isArray(e)?e.map(function(e){return{key:e,val:e}}):Object.keys(e).map(function(t){return{key:t,val:e[t]}})}},{key:"activateEventBus",value:function(){var e=this;return new Proxy({message:null},{set:function(t,n,r){return"processRegenQueue"===r.type&&e.processRegenQueue(),"createForeignGroupRelation"===r.type&&(e._collections[r.data.foreignCollection]._foreignGroupRelations[r.data.foreignData]={collection:r.data.dependentCollection,groupToRegen:r.data.dependentGroup}),"rebuildGroupsWithRelations"===r.type&&e._collections[r.data.collection].buildGroupFromIndex(r.data.groupToRegen),"undo"===r.type&&e.processUndo(r.data),t[n]="waiting",!0}})}},{key:"initStorage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t="custom";if(e.async||(e.async=!1),"sessionStorage"===e)t="sessionStorage",this.assignStorage(sessionStorage,t,e.async);else if(e&&e.set&&e.get)t="custom",this.assignStorage(e,t,e.async);else{if(this._global.config.ssr||!window.localStorage)return Utils_2("No storage API present, data will not persist");t="localStorage",this.assignStorage(localStorage,t,e.async)}}},{key:"assignStorage",value:function(e,t,n){var r={type:t,async:n};e.set&&(r.set=e.set.bind(e)),e.setItem&&(r.set=e.setItem.bind(e)),e.get&&(r.get=e.get.bind(e)),e.getItem&&(r.get=e.getItem.bind(e)),e.remove&&(r.remove=e.remove.bind(e)),e.removeItem&&(r.remove=e.removeItem.bind(e)),e.clear&&(r.clear=e.clear.bind(e)),this._global.storage=r}},{key:"prepareDependencyGraph",value:function(){for(var e=this,t=this._global.dependencyGraph,n=this._global.collectionNamespace,r=function(r){var i=n[r];t[i]={};for(var o=e._collections[i]._public,a=[],s=["filters","groups","data"],l=0;l<s.length;l++){var c=s[l];Object.keys(o[c]).forEach(function(e){return a.push(e)})}for(var u=0;u<a.length;u++){var h=a[u];t[i][h]={dependencies:[],dependents:[]}}},i=0;i<n.length;i++)r(i)}},{key:"initCollections",value:function(e,t,n){var r=this;this._collections.base=new Base(this._global,t,n),this._collections.request=new Request(this._global,n),this._global.collectionNamespace=["base","request"],Object.keys(e).forEach(function(t){r._global.collectionNamespace.push(t),r._collections[t]=new Collection({name:t,global:r._global},e[t])}),Object.keys(this._collections).forEach(function(e){r[e]?Utils_2('Collection name conflict, instance already has "'.concat(e,'" thus it will not be accessable on the root state tree.')):r[e]=r._collections[e]._public})}},{key:"buildGlobalDataRefrenceTree",value:function(){if(this._collections)for(var e=Object.keys(this._collections),t=0;t<e.length;t++){var n=e[t];this._global.dataRef[n]=this._collections[n]._public}}},{key:"executeAllFilters",value:function(){for(var e=Object.keys(this._collections),t=0;t<e.length;t++){var n=e[t];this._collections[n].analyseFilters()}}},{key:"processRegenQueue",value:function(){if(0!==this._global.regenQueue.length){for(Utils_1("Regen queue processing. There are ".concat(this._global.regenQueue.length," in the queue."));this._global.regenQueue.length;){var e=this._global.regenQueue.shift(),t="".concat(e.collection,"/").concat(e.property);if(t===this.lastRegenerated)return Utils_3("Prevented infinate loop for ".concat(t)),void(this.lastRegenerated="");this._collections[e.collection].executeAndAnalyseFilter(e.property),this.lastRegenerated=t,Utils_1("There are ".concat(this._global.regenQueue.length," properties left to regenerate."))}this._global.regenQueue.length>0?this.processRegenQueue():this.lastRegenerated=""}}},{key:"runOnReadyHandlers",value:function(){for(var e=Object.keys(this._collections),t=0;t<e.length;t++){this._collections[e[t]]._onReady()}}},{key:"processUndo",value:function(e){for(var t=0;t<e.length;t++){var n=e[t],r=this._collections[n.collection],i=n.data;switch(n.type){case"mutation":case"collect":break;case"update":r.update(i.dataId,i.previousValues);break;case"put":r.replaceIndex(i.group,i.previousDestIndex);break;case"remove":r.replaceIndex(i.group,i.previousValue);break;case"move":r.replaceIndex(i.fromIndex,i.previousFromIndexValue),i.toIndex&&r.replaceIndex(i.toIndex,i.previousToIndexValue);break;case"delete":r._public[i.primaryKey]=i.deleted,r.internalDataModified(i.primaryKey),r.recordHistory("restore",{primaryKey:i.primaryKey,deleted:i.deleted});break;case"restore":r.delete(i.primaryKey);break;case"newGroup":r.deleteGroup(i.createdGroup);break;case"deleteGroup":r.newGroup(i.group,i.previousValue);break;case"indexMutation":r.replaceIndex(i.index,i.previousIndex);break;case"decrement":r.increment(n.data.primaryKey,n.data.property,n.data.amount);break;case"increment":r.decrement(n.data.primaryKey,n.data.property,n.data.amount)}}}},{key:"initJobs",value:function(e){var t=this,n=this._global.dataRef;this._jobs={};for(var r=Object.keys(e),i=function(i){var o=e[r[i]],a=r[i],s=o.interval,l=o.execute,c={};"number"==typeof s?c.interval=s:"string"==typeof s&&(s.includes("s")?c.interval=1e3*parseInt(s.split("s")[0],10):s.includes("m")?c.interval=6e4*parseInt(s.split("m")[0],10):s.includes("hr")?c.interval=36e5*parseInt(s.split("hr")[0],10):s.includes("d")&&(c.interval=864e5*parseInt(s.split("d")[0],10))),c.execute=function(){return l(Object.assign(n,{endJob:t.endJob.bind(t,a)}))},o.startImmediate&&c.execute(),c.intervalId=setInterval(c.execute,c.interval),c.active=!0,t._jobs[a]||(t._jobs[a]=c)},o=0;o<r.length;o++)i(o)}},{key:"endJob",value:function(e){clearInterval(this._jobs[e].intervalId),this._jobs[e].active=!1}}]),e}(),index={Library:Pulse};module.exports=index;
//# sourceMappingURL=pulse.cjs.min.js.map
