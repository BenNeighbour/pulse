!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self,t.Pulse=e())}(this,function(){"use strict";function t(t,e){function i(){this.constructor=t}A(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function e(t,e,i,o){return new(i||(i=Promise))(function(n,r){function s(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){t.done?n(t.value):new i(function(e){e(t.value)}).then(s,a)}c((o=o.apply(t,e||[])).next())})}function i(t,e){function i(t){return function(e){return o([t,e])}}function o(i){if(n)throw new TypeError("Generator is already executing.");for(;c;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,r=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){c.label=i[1];break}if(6===i[0]&&c.label<s[1]){c.label=s[1],s=i;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(i);break}s[2]&&c.ops.pop(),c.trys.pop();continue}i=e.call(t,c)}catch(t){i=[6,t],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var n,r,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a}function o(t,e){return P({},e,t)}function n(){return Math.random().toString().split(".")[1]+Date.now()}function r(t,e,i){for(var o=i||Object.keys(t),n=0;n<o.length;n++){var r=o[n];e(r,t[r],o)}}function s(t){var e=typeof t;return null!=t&&"object"==e&&!function(t){try{return t instanceof HTMLElement}catch(e){return"object"==typeof t&&1===t.nodeType&&"object"==typeof t.style&&"object"==typeof t.ownerDocument}}(t)&&!Array.isArray(t)}function a(t){return Array.isArray(t)?t.map(function(t){return{key:t,val:t}}):Object.keys(t).map(function(e){return{key:e,val:t[e]}})}function c(t){if(!s(t))return t;for(var e=Object.assign({},t),i=Object.keys(e),o=0;o<i.length;o++){var n=i[o];s(e[n])&&(e[n]=c(e[n]))}return e}function p(t,e){return t({NO_PRIMARY_KEY:function(){return!1},INVALID_PARAMETER:function(){return!1},INDEX_NOT_FOUND:function(){return!1},INTERNAL_DATA_NOT_FOUND:function(){return!1},PROPERTY_NOT_A_NUMBER:function(){return!1}})()}function l(t,e){return"number"==typeof e&&"number"==typeof t}function u(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function h(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},o=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),o.forEach(function(e){W(t,e,i[e])})}return t}function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function y(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function b(t,e,i){return e&&y(t.prototype,e),i&&y(t,i),t}function d(t,e){return e={exports:{}},t(e,e.exports),e.exports}function g(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function v(t,e){return!e||"object"!==B(e)&&"function"!=typeof e?V(t):e}function m(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Q(t,e)}function D(){return(D=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o])}return t}).apply(this,arguments)}function _(t,e,i,o){return function(n){function r(e){var i;return q(this,r),i=Y(this,z(r).call(this,e)),i.state=J({},t.mapData(o,V(i),{waitForMount:!1!==t._private.global.config.waitForMount},t)),i}return $(r,n),X(r,[{key:"componentDidMount",value:function(){t._private.global.config.waitForMount&&t.mount(this)}},{key:"componentWillUnmount",value:function(){t._private.global.config.autoUnmount&&t.unmount(this)}},{key:"render",value:function(){return e.createElement(i,D({pulse:this.state},this.props))}}]),r}(e.Component)}var O,A=function(t,e){return(A=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},P=function(){return(P=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++){e=arguments[i];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t}).apply(this,arguments)},T=["data","indexes","groups","computed","actions","routes"],E=["collect","replaceIndex","getGroup","newGroup","deleteGroup","removeFromGroup","update","increment","decrement","delete","purge","watch","findById","put","move","throttle","forceUpdate","remove"],N=["push","pop","shift","unshift","splice","sort","reverse"],x=function(){function t(t,e,i,o,n){void 0===e&&(e="reactive"),void 0===n&&(n=null),this.global=t,this.type=e,this.colleciton=i,this.propertyName=o,this.rootProperty=n,this.dependents=new Set,this.subscribers=[],this.dynamicRelation=null}return t.prototype.register=function(){var t=this.global.subs;this.global.runningComputed&&this.dependents.add(this.global.runningComputed),this.global.runningPopulate&&this.global.relations.relate(this.global.runningPopulate,this),t.subscribingComponent&&this.subscribeComponent(),t.unsubscribingComponent},t.prototype.changed=function(){this.global.relations.cleanup(this.dynamicRelation)},t.prototype.subscribeComponent=function(){var t=this.global.subs;return this.rootProperty&&t.skimmingDeepReactive?void t.prepareNext(this):this.rootProperty?(t.foundDeepReactive(),void t.prepareNext(this)):(!this.rootProperty&&t.skimmingDeepReactive&&t.exitDeepReactive(),this.subscribe(),void t.prepareNext(this))},t.prototype.subscribe=function(){var t=this.global.subs,e=t.subscribingComponent.keys[t.subscribingComponentKey],i={componentUUID:t.subscribingComponent.componentUUID,key:e};this.subscribers.push(i)},t}(),I=function(){function t(t,e,i,o){this.global=t,this.collection=e,this.name=i,this.computedFunction=o,this.relatedToGroup=[],this.dynamicRelation=null}return t.prototype.run=function(){this.global.relations.cleanup(this.dynamicRelation),this.global.runningComputed=this;var t=this.computedFunction(this.global.getContext(this.collection));return void 0!==t&&null!==t||(t=!1),this.global.runningComputed=!1,t},t}(),U=function(){function t(t){this.updateThis=t,this.depsToClean=new Set}return t.prototype.destroy=function(){var t=this;this.depsToClean.forEach(function(e){return e.dependents.delete(t)}),delete this.updateThis.dynamicRelation},t}(),w=function(){function t(t){this.global=t,this.relationBank=new Set}return t.prototype.relate=function(t,e){if(e){var i=e;t.dynamicRelation||(t.dynamicRelation=new U(t),this.relationBank.add(t.dynamicRelation)),t.dynamicRelation.depsToClean.add(i),i.dependents.add(t.dynamicRelation)}},t.prototype.cleanup=function(t){t&&(t.destroy(),this.relationBank.delete(t))},t}();!function(t){t.COMPUTED_DEPENDS_ON_DATA="COMPUTED_DEPENDS_ON_DATA",t.COMPUTED_DEPENDS_ON_GROUP="COMPUTED_DEPENDS_ON_GROUP",t.DATA_DEPENDS_ON_DEP="DATA_DEPENDS_ON_DEP",t.DATA_DEPENDS_ON_GROUP="DATA_DEPENDS_ON_GROUP",t.DATA_DEPENDS_ON_DATA="DATA_DEPENDS_ON_DATA"}(O||(O={}));var R;!function(t){t.PUBLIC_DATA_MUTATION="PUBLIC_DATA_MUTATION",t.INTERNAL_DATA_MUTATION="INTERNAL_DATA_MUTATION",t.INDEX_UPDATE="INDEX_UPDATE",t.COMPUTED_REGEN="COMPUTED_REGEN",t.GROUP_UPDATE="GROUP_UPDATE",t.SOFT_GROUP_UPDATE="SOFT_GROUP_UPDATE",t.DELETE_INTERNAL_DATA="DELETE_INTERNAL_DATA"}(R||(R={}));var j=function(){function t(t,e){this.collections=t,this.global=e,this.running=!1,this.updatingSubscribers=!1,this.ingestQueue=[],this.completedJobs=[],this.archivedJobs=[],e.ingest=this.ingest.bind(this),e.ingestDependents=this.ingestDependents.bind(this),this.config=e.config}return t.prototype.ingest=function(t){this.ingestQueue.push(t),this.running||this.findNextJob()},t.prototype.findNextJob=function(){this.running=!0;var t=this.ingestQueue.shift();t.dep||t.type===R.INDEX_UPDATE||(t.dep=this.global.getDep(t.property,t.collection)),this.performJob(t)},t.prototype.performJob=function(t){switch(t.type){case R.PUBLIC_DATA_MUTATION:this.performPublicDataUpdate(t),this.collections[t.collection].runWatchers(t.property);break;case R.INTERNAL_DATA_MUTATION:this.performInternalDataUpdate(t);break;case R.INDEX_UPDATE:this.performIndexUpdate(t);break;case R.COMPUTED_REGEN:this.performComputedOutput(t),this.collections[t.collection].runWatchers(t.property.name);break;case R.GROUP_UPDATE:case R.SOFT_GROUP_UPDATE:this.performGroupRebuild(t),this.collections[t.collection].runWatchers(t.property);break;case R.DELETE_INTERNAL_DATA:this.performInternalDataDeletion(t)}t.dep&&t.dep.dependents.size>0&&this.ingestDependents(t.dep.dependents),this.finished()},t.prototype.ingestDependents=function(t){var e=this,i=function(t){return e.ingest({type:R.COMPUTED_REGEN,collection:t.collection,property:t,dep:e.global.getDep(t.name,t.collection)})};t.forEach(function(t){if(t instanceof I)i(t);else if(t instanceof U){var o=t.updateThis.constructor.name;o===I.name?i(t.updateThis):o===x.name&&e.ingest({type:R.INTERNAL_DATA_MUTATION,collection:t.updateThis.colleciton.name,property:t.updateThis.propertyName})}})},t.prototype.finished=function(){var t=this;if(this.running=!1,!(this.completedJobs.length>5e3))return this.ingestQueue.length>0?void this.findNextJob():void setTimeout(function(){0===t.ingestQueue.length?(t.updatingSubscribers||t.compileComponentUpdates(),t.cleanup()):t.findNextJob()})},t.prototype.performPublicDataUpdate=function(t){this.writeToPublicObject(t.collection,"data",t.property,t.value),this.completedJob(t)},t.prototype.performInternalDataUpdate=function(t){var e=this;t.value||this.collections[t.collection].internalData[t.property]&&(t.value=this.collections[t.collection].internalData[t.property]),t.previousValue=this.overwriteInternalData(t.collection,t.property,t.value),this.global.collecting||this.collections[t.collection].searchIndexesForPrimaryKey(t.property).forEach(function(i){var o=e.collections[t.collection].softUpdateGroupData(t.property,i);e.ingest({type:R.SOFT_GROUP_UPDATE,collection:t.collection,value:o,property:i,dep:e.global.getDep(i,t.collection)})}),this.completedJob(t)},t.prototype.performInternalDataDeletion=function(t){var e=this.collections[t.collection];t.previousValue=P({},e.internalData[t.property]),delete e.internalData[t.property];for(var i=this.collections[t.collection].searchIndexesForPrimaryKey(t.collection,t.property),o=0;o<i.length;o++){var n=i[o],r=e.indexes.object[n].slice().filter(function(e){return e!==t.property});this.ingest({type:R.INDEX_UPDATE,collection:e.name,property:n,value:r,dep:this.global.getDep(t.property,t.collection)})}this.completedJob(t)},t.prototype.performIndexUpdate=function(t){t.previousValue=this.collections[t.collection].indexes[t.property],this.collections[t.collection].indexes.privateWrite(t.property,t.value),this.completedJob(t),this.ingest({type:R.GROUP_UPDATE,collection:t.collection,property:t.property,dep:this.global.getDep(t.property,t.collection)})},t.prototype.performGroupRebuild=function(t){t.value||(t.value=this.collections[t.collection].buildGroupFromIndex(t.property)),this.writeToPublicObject(t.collection,"group",t.property,t.value),this.completedJob(t)},t.prototype.performComputedOutput=function(t){var e="string"==typeof t.property?this.collections[t.collection].computed[t.property]:t.property;t.value=e.run(),this.writeToPublicObject(t.collection,"computed",e.name,t.value),this.completedJob(t)},t.prototype.completedJob=function(t){t.fromAction=this.global.runningAction,this.global.initComplete&&this.completedJobs.push(t),this.persistData(t),t.dep&&t.dep.changed()},t.prototype.compileComponentUpdates=function(){if(this.global.initComplete){this.updatingSubscribers=!0,this.completedJobs;for(var t={},e=0;e<this.completedJobs.length;e++){var i=this.completedJobs[e];if(i.dep)for(var o=i.dep.subscribers,n=0;n<o.length;n++){var r=o[n].componentUUID,s=o[n].key;t[r]?t[r][s]=i.value:(t[r]={},t[r][s]=i.value)}}this.updateSubscribers(t),this.completedJobs=[]}},t.prototype.updateSubscribers=function(t){for(var e=Object.keys(t),i=this,o=0;o<e.length;o++){var n=function(o){var n=e[o],r=i.global.subs.componentStore[n];if(!r||!r.instance)return{value:void 0};var s=t[n],a=Object.keys(s);switch(i.global.config.framework){case"vue":a.forEach(function(t){var e=s[t];r.instance.$set(r.instance,t,c(e))});break;case"react":r.instance.setState(s)}}(o);if("object"==typeof n)return n.value}},t.prototype.persistData=function(t){t.type!==R.INTERNAL_DATA_MUTATION&&this.collections[t.collection].persist.includes(t.property)&&this.global.storage.set(t.collection,t.property,t.value)},t.prototype.cleanup=function(){var t=this;setTimeout(function(){t.updatingSubscribers=!1})},t.prototype.writeToPublicObject=function(t,e,i,o){if("indexes"===e){if(!this.collections[t][e].object.hasOwnProperty(i))return;this.collections[t][e].privateWrite(i,o)}else{if(!this.collections[t].public.object.hasOwnProperty(i))return;this.collections[t].public.privateWrite(i,o)}},t.prototype.overwriteInternalData=function(t,e,i){var o=this.collections[t].internalData,n=!!o[e]&&P({},o[e]);if(n){for(var r=Object.keys(i||{}),s=0;s<r.length;s++){var a=r[s];o[e][a]=i[a]}return n}return o[e]=i,!1},t}(),C=function(){function t(t,e,i,o,n){void 0===e&&(e="reactive"),void 0===n&&(n=null),this.global=t,this.type=e,this.colleciton=i,this.propertyName=o,this.rootProperty=n,this.dependents=new Set,this.subscribers=[],this.dynamicRelation=null}return t.prototype.register=function(){var t=this.global.subs;this.global.runningComputed&&this.dependents.add(this.global.runningComputed),this.global.runningPopulate&&this.global.relations.relate(this.global.runningPopulate,this),t.subscribingComponent&&this.subscribeComponent(),t.unsubscribingComponent},t.prototype.changed=function(){this.global.relations.cleanup(this.dynamicRelation)},t.prototype.subscribeComponent=function(){var t=this.global.subs;return this.rootProperty&&t.skimmingDeepReactive?void t.prepareNext(this):this.rootProperty?(t.foundDeepReactive(),void t.prepareNext(this)):(!this.rootProperty&&t.skimmingDeepReactive&&t.exitDeepReactive(),this.subscribe(),void t.prepareNext(this))},t.prototype.subscribe=function(){var t=this.global.subs,e=t.subscribingComponent.keys[t.subscribingComponentKey],i={componentUUID:t.subscribingComponent.componentUUID,key:e};this.subscribers.push(i)},t}(),k=function(){function t(t,e,i,o,n){void 0===t&&(t={}),this.global=e,this.collection=i,this.mutable=o,this.type=n,this.allowPrivateWrite=!1,this.touching=!1,this.tempDeps={},this.dispatch=this.global.dispatch,this.properties=Object.keys(t),this.object=this.reactiveObject(t)}return t.prototype.reactiveObject=function(t,e){for(var i=Object.keys(t),o=0;o<i.length;o++){var n=i[o];this.defineProperty(t,n,e)}return t},t.prototype.defineProperty=function(t,e,i){var o=this,n=t[e];t.rootProperty&&(i=t.rootProperty),s(n)&&!T.includes(e)&&(n=this.deepReactiveObject(n,i||e,e));var r=this.createDep(e,i);return Object.defineProperty(t,e,{get:function(){return o.sneaky?n:o.global.touching?(o.global.touched=r,n):(r.register(),n)},set:function(t){if(i&&o.mutable.includes(i))n=t,o.dispatch("mutation",{collection:o.collection.name,key:i,value:o.object[i],dep:r});else{if(T.includes(e))return n=t;if(o.allowPrivateWrite)return s(n)&&o.mutable.includes(e)&&(t=o.deepReactiveObject(t,i||e,e)),n=t;o.mutable.includes(e)&&o.dispatch("mutation",{collection:o.collection.name,key:e,value:t,dep:r})}}}),t},t.prototype.addProperty=function(t,e){this.object[t]=e,this.defineProperty(this.object,t)},t.prototype.tempDep=function(t){var e=this.createDep(t);return this.tempDeps[t]=e,e},t.prototype.cloneDep=function(t){return t=Object.assign(Object.create(Object.getPrototypeOf(t)),t)},t.prototype.createDep=function(t,e){return this.tempDeps.hasOwnProperty(t)&&!e?this.cloneDep(this.tempDeps[t]):new C(this.global,"indexes"===this.type?"index":"reactive",this.collection,t,e)},t.prototype.deepReactiveObject=function(t,e,i){for(var o=Object.create({rootProperty:e,propertyName:i}),n=Object.keys(t),r=0;r<n.length;r++){var s=n[r];o[s]=t[s]}this.allowPrivateWrite=!0;var a=this.reactiveObject(o,e);return this.allowPrivateWrite=!1,a},t.prototype.reactiveArray=function(t,e){for(var i=this,o=t.slice(),n=0;n<N.length;n++)!function(t){var n=N[t],r=Array.prototype[n];Object.defineProperty(o,n,{value:function(){var t=r.apply(this,arguments);return i.global.initComplete&&i.dispatch("mutation",{collection:i.collection.name,key:e,value:t}),t}})}(n);return o},t.prototype.privateWrite=function(t,e){this.allowPrivateWrite=!0,this.object[t]=e,this.allowPrivateWrite=!1},t.prototype.privateGet=function(t){this.sneaky=!0;var e=this.object[t];return this.sneaky=!1,e},t.prototype.exists=function(t){this.sneaky=!0;var e=!!this.object.hasOwnProperty(t);return this.sneaky=!1,e},t.prototype.getKeys=function(){this.sneaky=!0;var t=Object.keys(this.object);return this.sneaky=!1,t},t}(),S=function(){function t(t,e,i,o){this.collection=t,this.global=e,this.action=i,this.actionName=o,this.executing=!1,this.uuid=n(),this.prepare(i,e,this.global.contextRef.undo)}return t.prototype.prepare=function(t,e,i){var o=this;this.exec=function(){var n=this,r=e.getContext(o.collection);r.undo=function(t){return i(n.actionName,n.uuid,t)},e.runningAction=o,o.executing=!0;var s=t.apply(null,[r].concat(Array.prototype.slice.call(arguments)));return o.executing=!1,e.runningAction=!1,s}},t}(),G=function(){function t(t,e,i){this.name=t,this.global=e,this.config={},this.keys={},this.methods={},this.actions={},this.computed={},this.watchers={},this.externalWatchers={},this.persist=[],this.local={},this.model={},this.collectionSize=0,this.primaryKey=!1,this.internalData={},this.internalDataDeps={},this.internalDataWithPopulate=[],this.config=i.config,this.dispatch=this.global.dispatch,i.computed=P({},i.computed,i.filters),i=this.prepareNamespace(i),this.initReactive(i.data,i.groups),this.initRoutes(i.routes),this.initActions(i.actions),this.initWatchers(i.watch),this.initComputed(i.computed),this.initModel(i.model),this.initPersist(i.persist)}return t.prototype.prepareNamespace=function(t){var e=this;return E.map(function(t){return e.methods[t]=e[t].bind(e)}),t.local&&(this.local=t.local),["data","actions","computed","indexes","routes","watch"].forEach(function(i){"indexes"===i||t[i]||(t[i]={}),e.keys[i]="indexes"===i?t.groups||[]:Object.keys(t[i])}),this.namespace=Object.assign(Object.create(P({},this.methods)),P({routes:{},indexes:{},actions:t.actions},t.computed,t.data,this.normalizeGroups(t.groups))),t},t.prototype.normalizeGroups=function(t){void 0===t&&(t=[]);for(var e={},i=0;i<t.length;i++)e[t[i]]=[];return e},t.prototype.runWatchers=function(t){var e=this.watchers[t];e&&e();var i=this.externalWatchers[t];i&&i.forEach(function(t){return"function"==typeof t&&t()})},t.prototype.initReactive=function(t,e){void 0===e&&(e=[]),e=this.normalizeGroups(e),this.indexes=new k(e,this.global,this,this.keys.indexes,"indexes"),this.namespace.indexes=this.indexes.object,this.public=new k(this.namespace,this.global,this,this.keys.data.concat(this.keys.indexes),"root")},t.prototype.initPersist=function(t){var e=this;if(Array.isArray(t))for(var i=this,o=0;o<t.length;o++)!function(o){var n=t[o];if(i.persist.push(n),i.global.storage.isPromise)i.global.storage.get(i.name,n).then(function(t){if(void 0!==t&&null!==t){var i={type:R.PUBLIC_DATA_MUTATION,value:t,property:n,collection:e.name,dep:e.global.getDep(n,e.name)};e.global.ingest(i)}});else{var r=i.global.storage.get(i.name,n);if(void 0===r||null===r)return"continue";i.public.privateWrite(n,r)}}(o)},t.prototype.initActions=function(t){void 0===t&&(t={});for(var e=Object.keys(t),i=0;i<e.length;i++){var o=t[e[i]];this.actions[e[i]]=new S(this.name,this.global,o,e[i]),this.public.privateWrite(e[i],this.actions[e[i]].exec)}},t.prototype.initWatchers=function(t){var e=this;void 0===t&&(t={});for(var i=Object.keys(t),o=this,n=0;n<i.length;n++)!function(n){var r=t[i[n]];o.watchers[i[n]]=function(){e.global.runningWatcher={collection:e.name,property:i[n]};var t=r(e.global.getContext(e.name));return e.global.runningWatcher=!1,t}}(n);this.watchers._keys=i},t.prototype.initComputed=function(t){var e=this;r(t,function(t,i){e.computed[t]=new I(e.global,e.name,t,i),e.public.object[t]=[]},this.keys.computed)},t.prototype.initRoutes=function(t){var e=this,i=this,o=function(e){return function(){var o=Object.assign({},i.global.request);return o.context=i.global.getContext(),t[e].apply(null,[o].concat(Array.prototype.slice.call(arguments)))}};r(t,function(t){return e.public.object.routes[t]=o(t)})},t.prototype.initModel=function(t){var e=this;void 0===t&&(t={}),this.model=t,Object.keys(t).forEach(function(i){Object.keys(t[i]).forEach(function(t){switch(t){case"primaryKey":e.primaryKey=i;break;case"populate":e.internalDataWithPopulate.push(i)}})})},t.prototype.getData=function(t){return P({},this.internalData[t])},t.prototype.buildGroupFromIndex=function(t){var e=[],i=this.indexes.privateGet(t);if(!i)return[];for(var o=0;o<i.length;o++){var n=i[o],r=this.getData(n);r&&(r=this.injectDynamicRelatedData(n,r),e.push(r))}return e},t.prototype.softUpdateGroupData=function(t,e){var i=this.indexes.privateGet(e).indexOf(t);if(!this.public[e])return this.buildGroupFromIndex(e);var o=[this.public[e]],n=P({},this.internalData[t]);return n=this.injectDynamicRelatedData(t,n),o[i]=n,o},t.prototype.injectDynamicRelatedData=function(t,e){var i=this;return this.internalDataWithPopulate.forEach(function(o){var n=i.global.getDep(t,i.name,!0);i.global.runningPopulate=n;var r=i.model[o].populate(i.global.getContext(),e);i.global.runningPopulate=!1,e[o]=r}),e},t.prototype.createGroups=function(t){void 0===t?t=[]:Array.isArray(t)||(t=[t]);for(var e=0;e<t.length;e++){var i=t[e];this.indexes.exists(i)||this.indexes.addProperty(i,[])}return t},t.prototype.collect=function(t,e,i){var n=this;i=o(i,{append:!0}),this.global.collecting=!0,Array.isArray(t)||(t=[t]);for(var r=this.createGroups(e),s=this.getPreviousIndexValues(r),a=new Set,c=0;c<t.length;c++){var p=t[c];if(null!==p){var l=this.processDataItem(p,r,i);l&&(l.success&&this.collectionSize++,l.affectedIndexes.forEach(function(t){return a.add(t)}))}}a.forEach(function(t){n.global.ingest({type:R.INDEX_UPDATE,collection:n.name,property:t,value:n.indexes.privateGet(t),previousValue:s[t],dep:n.global.getDep(t,n.indexes.object)})}),this.global.collecting=!1},t.prototype.processDataItem=function(t,e,i){if(void 0===e&&(e=[]),this.primaryKey||this.findPrimaryKey(t),!this.primaryKey)return!1;var o=t[this.primaryKey],n=e.slice();this.searchIndexesForPrimaryKey(o).map(function(t){return!n.includes(t)&&n.push(t)}),this.internalDataDeps[o]||(this.internalDataDeps[o]=new C(this.global,"internal",this,o)),this.global.ingest({type:R.INTERNAL_DATA_MUTATION,collection:this.name,property:o,value:t,dep:this.internalDataDeps[o]});for(var r=0;r<e.length;r++){var s=e[r],a=this.indexes.privateGet(s);a=a.filter(function(t){return t!=o}),i.append?a.push(o):a.unshift(o),this.indexes.privateWrite(s,a)}return{success:!0,affectedIndexes:n}},t.prototype.searchIndexesForPrimaryKey=function(t){for(var e=this.indexes.getKeys(),i=[],o=0;o<e.length;o++){var n=e[o];this.indexes.privateGet(n).includes(t)&&i.push(n)}return i},t.prototype.getPreviousIndexValues=function(t){for(var e={},i=0;i<t;i++){var o=t[i];e[o]=this.indexes.privateGet(o)}return e},t.prototype.findPrimaryKey=function(t){return t.hasOwnProperty("id")?this.primaryKey="id":t.hasOwnProperty("_id")?this.primaryKey="_id":t.hasOwnProperty("key")&&(this.primaryKey="key"),!!this.primaryKey||p(function(t){return t.NO_PRIMARY_KEY})},t.prototype.replaceIndex=function(t,e){if(!Array.isArray(e)||"string"!=typeof t)return p(function(t){return t.INVALID_PARAMETER});this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:t,value:e})},t.prototype.depForInternalData=function(t){var e;return this.internalDataDeps[t]?e=this.internalDataDeps[t]:(e=new C(this.global,"internal",this,t),this.internalDataDeps[t]=e),e},t.prototype.depForGroup=function(t){return this.public.exists(t)?this.global.getDep(t,this.name):this.indexes.exists(t)?this.global.getDep(t,this.indexes.object):this.indexes.tempDep(t)},t.prototype.findById=function(t){var e=this.depForInternalData(t);if(this.global.runningComputed){var i=this.global.runningComputed;this.global.relations.relate(i,e)}if(this.global.runningPopulate){var o=this.global.runningPopulate;this.global.relations.relate(o,e)}return this.internalData[t]},t.prototype.getGroup=function(t){var e=this.depForGroup(t);if(this.global.runningComputed){var i=this.global.runningComputed;this.global.relations.relate(i,e)}if(this.global.runningPopulate){var o=this.global.runningPopulate;this.global.relations.relate(o,e)}return this.buildGroupFromIndex(t)||[]},t.prototype.undo=function(){},t.prototype.throttle=function(){},t.prototype.move=function(t,e,i,o){if(void 0===o&&(o="push"),!this.indexes.exists(e))return p(function(t){return t.INDEX_NOT_FOUND});if(i&&!this.indexes.exists(i))return p(function(t){return t.INDEX_NOT_FOUND});Array.isArray(t)||(t=[t]);for(var n=this.indexes.privateGet(e),r=0;r<t.length;r++)!function(e){n=n.filter(function(i){return i!==t[e]})}(r);if(this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:e,value:n}),i){for(var s=this.indexes.privateGet(i),r=0;r<t.length;r++)s.includes(t[r])||s[o](t[r]);this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:i,value:s})}},t.prototype.put=function(t,e,i){if(void 0===i&&(i="push"),!this.indexes.exists(e))return p(function(t){return t.INDEX_NOT_FOUND});Array.isArray(t)||(t=[t]);for(var o=this.indexes.privateGet(e),n=0;n<t.length;n++)o.includes(t[n])||o[i](t[n]);this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:e,value:o})},t.prototype.newGroup=function(t,e){if(this.indexes.object.hasOwnProperty(t))return p(function(t){return t.GROUP_ALREADY_EXISTS});this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:t,value:e})},t.prototype.deleteGroup=function(t){this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:t,value:[]})},t.prototype.removeFromGroup=function(t,e){if(!this.indexes.exists(t))return p(function(t){return t.INDEX_NOT_FOUND});Array.isArray(e)||(e=[e]);var i=this.indexes.privateGet(t).filter(function(t){return!e.includes(t)});this.global.ingest({type:R.INDEX_UPDATE,collection:this.name,property:t,value:i})},t.prototype.update=function(t,e){if(!this.internalData.hasOwnProperty(t))return p(function(t){return t.INTERNAL_DATA_NOT_FOUND});for(var i=Object.keys(e),o=Object.assign({},this.internalData[t]),n=0;n<i.length;n++){var r=i[n];o[r]=e[r]}this.global.ingest({type:R.INTERNAL_DATA_MUTATION,collection:this.name,property:t,value:o})},t.prototype.increment=function(t,e,i,o){if(!this.internalData.hasOwnProperty(t))return p(function(t){return t.INTERNAL_DATA_NOT_FOUND});var n=Object.assign({},this.internalData[t]);if(!l(i,n[e]))return p(function(t){return t.PROPERTY_NOT_A_NUMBER});o?n[e]-=i:n[e]+=i,this.global.ingest({type:R.INTERNAL_DATA_MUTATION,collection:this.name,property:t,value:n})},t.prototype.decrement=function(t,e,i){this.increment(t,e,i,!0)},t.prototype.delete=function(t){Array.isArray(t)||(t=[t]);for(var e=0;e<t.length;e++){var i=t[e];this.global.ingest({type:R.DELETE_INTERNAL_DATA,collection:this.name,property:i})}},t.prototype.purge=function(){},t.prototype.watch=function(t,e){this.externalWatchers[t]?this.externalWatchers[t].push(e):this.externalWatchers[t]=[e]},t.prototype.forceUpdate=function(t){this.public.exists(t)&&(this.public.mutable.includes(t)?this.global.ingest({type:R.PUBLIC_DATA_MUTATION,property:t,collection:this.name,value:this.public.privateGet(t),dep:this.global.getDep(t,this.name)}):this.computed[t]&&this.global.ingest({type:R.COMPUTED_REGEN,property:t,collection:this.name,dep:this.global.getDep(t,this.name)}))},t.prototype.remove=function(t,e){return this.removeFromGroup(e,t)},t}(),M=function(){function t(t){this.getContext=t,this.subscribingComponentKey=0,this.subscribingComponent=!1,this.unsubscribingComponent=!1,this.skimmingDeepReactive=!1,this.uuid=n,this.lastAccessedDep=null,this.componentStore={}}return t.prototype.registerComponent=function(t,e){var i=t.__pulseUniqueIdentifier;if(i)this.mount(t);else{var o={instance:t,uuid:i=this.uuid(),ready:!e.waitForMount};t.__pulseUniqueIdentifier=i,this.componentStore[i]=o}return i},t.prototype.mount=function(t){var e=this.componentStore[t.__pulseUniqueIdentifier];e&&(e.instance=t,e.ready=!0)},t.prototype.unmount=function(t){t.__pulseUniqueIdentifier&&delete this.componentStore[t.__pulseUniqueIdentifier]},t.prototype.subscribePropertiesToComponents=function(t,e){var i=t(this.getContext()),o=Object.keys(i);this.subscribingComponentKey=0,this.subscribingComponent={componentUUID:e,keys:o};var n=t(this.getContext());return this.subscribingComponent=!1,this.subscribingComponentKey=0,n},t.prototype.prepareNext=function(t){this.lastAccessedDep=t,this.skimmingDeepReactive||this.subscribingComponentKey++},t.prototype.foundDeepReactive=function(){this.skimmingDeepReactive=!0,this.lastAccessedDep.subscribers.pop(),this.subscribingComponentKey--},t.prototype.exitDeepReactive=function(){this.skimmingDeepReactive=!1,this.lastAccessedDep.subscribe(),this.subscribingComponentKey++},t}(),K=function(){function t(t){void 0===t&&(t={}),this.storageMethods=t,this.isPromise=!1,this.storageReady=!1,this.storageType="localStorage",t.async&&(this.isPromise=!0),(t.get||t.set||t.remove)&&(this.storageType="custom"),this.localStorageAvaliable()&&"localStorage"===this.storageType?(this.storageReady=!0,t.get=localStorage.getItem.bind(localStorage),t.set=localStorage.setItem.bind(localStorage),t.remove=localStorage.removeItem.bind(localStorage)):(this.storageType="custom",this.check(t.get)&&this.check(t.set)&&this.check(t.remove)?this.storageReady=!0:this.storageReady=!1)}return t.prototype.get=function(t,e){var i=this;if(this.storageReady)return this.isPromise?new Promise(function(o,n){i.storageMethods.get(i.getKey(t,e)).then(function(t){if("string"!=typeof t)return o(t);o(JSON.parse(t))}).catch(n)}):JSON.parse(this.storageMethods.get(this.getKey(t,e)))},t.prototype.set=function(t,e,i){this.storageReady&&this.storageMethods.set(this.getKey(t,e),JSON.stringify(i))},t.prototype.remove=function(t,e){this.storageReady&&this.storageMethods.remove(this.getKey(t,e))},t.prototype.getKey=function(t,e){return"_"+t+"_"+e},t.prototype.check=function(t){return"function"==typeof t},t.prototype.localStorageAvaliable=function(){try{return localStorage.setItem("_","_"),localStorage.removeItem("_"),!0}catch(t){return!1}},t}(),F=function(o){function n(t,e){var i=this,n=[],r=["baseURL"],s={baseURL:e.baseURL||"",mode:"cors",credentials:"same-origin",headers:{Accept:"application/json"}};return e.headers&&Object.keys(e.headers).forEach(function(t){s.headers[t]=e.headers[t]}),e.credentials&&(s.credentials=e.credentials),e.mode&&(s.mode=e.mode),i=o.call(this,"request",t,{groups:n,data:s,persist:r})||this,i.requestIntercept=e.requestIntercept,i.responseIntercept=e.responseIntercept,i.timeout=e.timeout,i.saveHistory=void 0===e.saveHistory,i.global.request={get:i.get.bind(i),post:i.post.bind(i),put:i._put.bind(i),patch:i.patch.bind(i),delete:i.delete.bind(i),queryify:i.queryify.bind(i)},i}return t(n,o),n.prototype.get=function(t,e){return this.send(t,"get",{},e)},n.prototype.post=function(t,e,i){return this.send(t,"post",e,i)},n.prototype._put=function(t,e,i){return this.send(t,"put",e,i)},n.prototype.patch=function(t,e,i){return this.send(t,"patch",e,i)},n.prototype.delete=function(t,e,i){return this.send(t,"delete",e,i)},n.prototype.send=function(t,o,n,r){return void 0===n&&(n={}),e(this,void 0,void 0,function(){var e,s,a,c,p,l,u,h,f,y=this;return i(this,function(i){switch(i.label){case 0:return e=Object.assign({},this.public.object.headers),r&&Object.keys(r).forEach(function(t){e[t]=r[t]}),"get"!==o&&void 0===e["Content-Type"]&&(e["Content-Type"]="application/json"),s=t.startsWith("http")?t:this.public.object.baseURL+"/"+t,n=JSON.stringify(n),this.options={},this.options.credentials=this.public.object.credentials,this.options.mode=this.public.object.mode,a=Object.assign({headers:e,method:o.toUpperCase(),body:"get"===o?null:n},this.options),this.requestIntercept&&this.requestIntercept(this.global.getContext("request"),a),this.timeout?[4,Promise.race([fetch(s,a),new Promise(function(t,e){return setTimeout(function(){return e("timeout")},y.timeout)})])]:[3,2];case 1:return c=i.sent(),[3,4];case 2:return[4,fetch(s,a)];case 3:c=i.sent(),i.label=4;case 4:return p=c.headers.get("content-type"),p&&-1!==p.indexOf("application/json")?[4,c.json()]:[3,6];case 5:return n=i.sent(),[3,8];case 6:return[4,c.text()];case 7:n=i.sent(),i.label=8;case 8:if(this.saveHistory||this.collect({id:Date.now(),status:c.status,timestamp:new Date,response:n}),Array.isArray(n)||"object"!=typeof n)l=n;else for(l=Object.create({response:function(){return c}}),u=Object.keys(n),h=0;h<u.length;h++)f=u[h],l[f]=n[f];if(this.responseIntercept&&(c.data=n,this.responseIntercept(this.global.getContext("request"),c)),c.ok||c.redirected)return[2,l];throw l}})})},n.prototype.queryify=function(t){var e=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}};if("object"==typeof t)return Object.keys(t).map(function(i){var o=encodeURIComponent(e(i))+"=";return Array.isArray(t[i])?t[i].map(function(t){return o+encodeURIComponent(e(t))}).join("&"):o+encodeURIComponent(e(t[i]))}).join("&")},n}(G),L=function(e){function i(t,i){void 0===i&&(i={});return i=Object.assign({},i),delete i.collections,delete i.request,i.data||(i.data={}),i.persist||(i.persist=[]),i.data.isAuthenticated=!1,i.persist.push("isAuthenticated"),i.data.appReady=!1,e.call(this,"base",t,i)||this}return t(i,e),i}(G),W=u,J=h,q=f,X=b,B=d(function(t){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function i(o){return"function"==typeof Symbol&&"symbol"===e(Symbol.iterator)?t.exports=i=function(t){return e(t)}:t.exports=i=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":e(t)},i(o)}t.exports=i}),V=g,Y=v,z=d(function(t){function e(i){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(i)}t.exports=e}),Q=d(function(t){function e(i,o){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},e(i,o)}t.exports=e}),$=m;return function(){function t(t){var e=this;void 0===t&&(t={}),this._private={runtime:null,events:{},collections:{},collectionKeys:[],global:{config:this.prepareConfig(t.config),initComplete:!1,runningAction:!1,runningWatcher:!1,runningComputed:!1,runningPopulate:!1,mappingData:!1,collecting:!1,touching:!1,touched:!1,contextRef:{},subs:new M(this.getContext.bind(this)),relations:null,storage:null,dispatch:this.dispatch.bind(this),getInternalData:this.getInternalData.bind(this),getContext:this.getContext.bind(this),getDep:this.getDep.bind(this),uuid:n}},["utils","services","staticData"].forEach(function(i){t[i]&&(e[i]=t[i])}),this._private.global.storage=new K(t.storage),this._private.global.relations=new w(this._private.global),this.initCollections(t),this.initRuntime(),this.bindCollectionPublicData(),this.runAllComputed(),this.initComplete()}return t.prototype.initCollections=function(t){if(this._private.collectionKeys=[],t.collections){this._private.collectionKeys=Object.keys(t.collections).concat(this._private.collectionKeys);for(var e=0;e<this._private.collectionKeys.length;e++)this._private.collections[this._private.collectionKeys[e]]=new G(this._private.collectionKeys[e],this._private.global,t.collections[this._private.collectionKeys[e]])}!1!==this._private.global.config.enableRequest&&this._private.collectionKeys.push("request"),this._private.collections.request=new F(this._private.global,t.request||{}),!1!==this._private.global.config.enableBase&&(this._private.collectionKeys.push("base"),this._private.collections.base=new L(this._private.global,t))},t.prototype.initRuntime=function(){this._private.runtime=new j(this._private.collections,this._private.global)},t.prototype.bindCollectionPublicData=function(){for(var t=0;t<this._private.collectionKeys.length;t++){var e=this._private.collections[this._private.collectionKeys[t]];this._private.global.contextRef[this._private.collectionKeys[t]]=e.public.object,this[this._private.collectionKeys[t]]=e.public.object}},t.prototype.runAllComputed=function(){for(var t=0;t<this._private.collectionKeys.length;t++)for(var e=this._private.collections[this._private.collectionKeys[t]],i=e.keys.computed,o=0;o<i.length;o++){var n=i[o];this._private.runtime.performComputedOutput({collection:e.name,property:n,type:R.COMPUTED_REGEN}),e.runWatchers(n)}},t.prototype.initComplete=function(){if(this._private.global.initComplete=!0,Object.assign({},this),!this._private.global.config.ssr)try{window._pulse=this}catch(t){}},t.prototype.wrapped=function(t,e){var i=this._private.global.config;return!("react"!==i.framework||!i.frameworkConstructor)&&_(this,i.frameworkConstructor,t,e)},t.prototype.prepareConfig=function(t){return(t=o(t,{framework:null,waitForMount:!1,autoUnmount:!1})).framework&&t.framework.hasOwnProperty("__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED")&&(t.frameworkConstructor=t.framework,t.framework="react"),"react"===t.framework&&(0!=t.waitForMount&&(t.waitForMount=!0),0!=t.autoUnmount&&(t.autoUnmount=!0)),t},t.prototype.getInternalData=function(t,e){return this._private.collections[t].findById(e)},t.prototype.getDep=function(t,e,i){var o;return i?o=this._private.collections[e].internalDataDeps[t]:(this._private.global.touching=!0,"string"==typeof e?this._private.collections[e].public.object[t]:"object"==typeof e&&e[t],o=this._private.global.touched,this._private.global.touching=!1,this._private.global.touched=null,o||(o=this._private.collections[e].internalDataDeps[t])),o},t.prototype.dispatch=function(t,e){switch(t){case"mutation":this._private.runtime.ingest({type:R.PUBLIC_DATA_MUTATION,collection:e.collection,property:e.key,value:e.value,dep:e.dep})}},t.prototype.getContext=function(t){var e=this._private.collections[t];return e?P({},this._private.global.contextRef,e.methods,{data:e.public.object,indexes:e.indexes.object,groups:e.public.object,computed:e.public.object,routes:e.public.object.routes,local:e.local}):this._private.global.contextRef},t.prototype.install=function(t){this._private.global.config.framework="vue";var e=this,i=e._private.global.config;t.mixin({beforeCreate:function(){var t=this;Object.keys(e._private.global.contextRef).forEach(function(i){t["$"+i]=e._private.global.contextRef[i]}),e.utils&&(this.$utils=e.utils),e.services&&(this.$services=e.services),e.staticData&&(this.$staticData=e.staticData),this.mapData=function(o){return e.mapData(o,t,{waitForMount:i.waitForMount},e)}},mounted:function(){this.__pulseUniqueIdentifier&&i.waitForMount&&e.mount(this)},beforeDestroy:function(){this.__pulseUniqueIdentifier&&i.autoUnmount&&e.unmount(this)}})},t.prototype.mount=function(t){this._private.global.subs.mount(t)},t.prototype.unmount=function(t){this._private.global.subs.unmount(t)},t.prototype.mapData=function(t,e,i,o){void 0===e&&(e={}),void 0===i&&(i={});var n=o||this,r=P({waitForMount:!0},i),s=n._private.global.subs.registerComponent(e,r);if(this._private.global.mappingData=!0,"function"==typeof t)return n._private.global.subs.subscribePropertiesToComponents(t,s);if("object"==typeof t){var p={};return a(t).forEach(function(t){var e=t.key,i=t.val,o=i.split("/")[0],r=i.split("/")[1],a=n._private.global.getContext()[o];p[e]=n._private.global.subs.subscribePropertiesToComponents(function(){var t;return t={},t[e]=a[r],t},s)[e]}),this._private.global.mappingData=!1,p=c(p)}},t.prototype.emit=function(t,e){if(this._private.events[t])for(var i=0;i<this._private.events[t].length;i++)(0,this._private.events[t][i])(e)},t.prototype.on=function(t,e){Array.isArray(this._private.events[t])?this._private.events[t].push(e):this._private.events[t]=[e]},t.prototype.log=function(t){},t}()});
//# sourceMappingURL=pulse.min.js.map
